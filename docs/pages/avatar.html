<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SLATE Avatar - Living Orrery visualization of the S.L.A.T.E. system architecture">
    <title>SLATE Avatar - The Architect</title>
    <link rel="icon" type="image/svg+xml" href="assets/slate-logo-v2.svg">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #B85A3C;
            --primary-light: #D4785A;
            --primary-dark: #8B4530;
            --blueprint-bg: #0D1B2A;
            --blueprint-grid: #1B3A4B;
            --blueprint-accent: #4FC3F7;
            --jewel-active: #4CAF50;
            --jewel-pending: #FF9800;
            --jewel-error: #F44336;
            --jewel-locked: #424242;
            --surface-dark: #1A1816;
            --font-display: 'Segoe UI', 'Inter', system-ui, sans-serif;
            --font-mono: 'Consolas', 'JetBrains Mono', monospace;
        }

        body {
            background: var(--blueprint-bg);
            color: #E8E2DE;
            font-family: var(--font-display);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Blueprint grid background */
        .blueprint-grid {
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(27, 58, 75, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(27, 58, 75, 0.3) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(13, 27, 42, 0.95) 0%, transparent 100%);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left img {
            width: 32px;
            height: 32px;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-light);
            letter-spacing: 0.05em;
        }

        .header-subtitle {
            font-size: 0.75rem;
            color: rgba(232, 226, 222, 0.6);
            font-family: var(--font-mono);
        }

        .header-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .level-badge {
            background: rgba(184, 90, 60, 0.2);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 4px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-light);
            font-family: var(--font-mono);
        }

        .stats-chip {
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 0.7rem;
            color: var(--blueprint-accent);
            font-family: var(--font-mono);
        }

        .back-link {
            color: rgba(232, 226, 222, 0.5);
            text-decoration: none;
            font-size: 0.8rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--primary-light);
        }

        /* SVG container */
        #avatar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        #avatar-svg {
            width: 100%;
            height: 100%;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            pointer-events: none;
            background: rgba(26, 24, 22, 0.95);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.8rem;
            color: #E8E2DE;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.15s;
            max-width: 240px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-label {
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 4px;
        }

        .tooltip-detail {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: rgba(232, 226, 222, 0.7);
        }

        /* Legend */
        .legend {
            position: fixed;
            bottom: 16px;
            left: 16px;
            z-index: 10;
            background: rgba(13, 27, 42, 0.85);
            border: 1px solid var(--blueprint-grid);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.7rem;
            font-family: var(--font-mono);
        }

        .legend-title {
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 6px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 3px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Progress panel */
        .progress-panel {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 10;
            background: rgba(13, 27, 42, 0.85);
            border: 1px solid var(--blueprint-grid);
            border-radius: 12px;
            padding: 14px 18px;
            min-width: 200px;
        }

        .progress-title {
            font-weight: 700;
            color: var(--primary-light);
            font-size: 0.75rem;
            margin-bottom: 8px;
            font-family: var(--font-mono);
        }

        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            overflow: hidden;
            margin: 4px 0 8px;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 1s ease;
        }

        .progress-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            font-family: var(--font-mono);
            color: rgba(232, 226, 222, 0.6);
            margin-bottom: 2px;
        }

        .progress-stat span:last-child {
            color: var(--blueprint-accent);
        }

        /* Glow filter for active nodes */
        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="blueprint-grid"></div>

    <header class="header">
        <div class="header-left">
            <img src="assets/slate-logo-v2.svg" alt="SLATE">
            <div>
                <div class="header-title">SLATE Avatar</div>
                <div class="header-subtitle" id="level-subtitle">Level 3 &mdash; Full Orrery</div>
            </div>
        </div>
        <div class="header-right">
            <span class="level-badge" id="level-badge">Level 3</span>
            <span class="stats-chip" id="stats-chip">44 nodes | 81.8%</span>
            <a href="./" class="back-link">&larr; Back to SLATE</a>
        </div>
    </header>

    <div id="avatar-container">
        <svg id="avatar-svg"></svg>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-label" id="tooltip-label"></div>
        <div class="tooltip-detail" id="tooltip-detail"></div>
    </div>

    <div class="legend">
        <div class="legend-title">Node Types</div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#B85A3C"></div> Core
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#4FC3F7"></div> AI Service
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#4CAF50"></div> UI / Dashboard
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#FF9800"></div> Infrastructure
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#9C27B0"></div> Data
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#2196F3"></div> Bridge / API
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#FFC107"></div> Security
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#76B900"></div> Hardware
        </div>
    </div>

    <div class="progress-panel" id="progress-panel">
        <div class="progress-title">Tech Tree v3.0.0</div>
        <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progress-fill" style="width:81.8%"></div>
        </div>
        <div class="progress-stat"><span>Complete</span><span id="stat-complete">36/44</span></div>
        <div class="progress-stat"><span>In Progress</span><span id="stat-progress">3</span></div>
        <div class="progress-stat"><span>Available</span><span id="stat-available">5</span></div>
        <div class="progress-stat"><span>Connections</span><span id="stat-connections">22</span></div>
    </div>

    <script>
        (function () {
            'use strict';

            // ── Avatar Data (embedded from slate_avatar.py --json) ──────────
            // In production this would fetch from /api/avatar or avatar_state.json
            var AVATAR = {
                level: 3,
                level_name: "Full Orrery",
                expression: "idle",
                orbit_speed: 0.3,
                tech_tree: { total_nodes: 44, complete: 36, in_progress: 3, available: 5, completion_pct: 81.8, total_edges: 60, version: "3.0.0" },
                design: {
                    primary: "#B85A3C",
                    blueprint_bg: "#0D1B2A",
                    blueprint_grid: "#1B3A4B",
                    jewel_active: "#4CAF50",
                    jewel_pending: "#FF9800",
                    jewel_error: "#F44336",
                    jewel_locked: "#424242"
                },
                rings: {
                    core: { radius: 0, visible: true, node_count: 1 },
                    inner: { radius: 120, visible: true, node_count: 5 },
                    middle: { radius: 220, visible: true, node_count: 7 },
                    outer: { radius: 320, visible: true, node_count: 4 }
                },
                nodes: [
                    { id: "core", label: "SLATE Core", ring: 0, angle: 0, type: "core", color: "#B85A3C", visible: true, health: "active" },
                    { id: "ollama", label: "Ollama", ring: 1, angle: 0, type: "ai", color: "#4FC3F7", visible: true, health: "active", port: 11434 },
                    { id: "dashboard", label: "Dashboard", ring: 1, angle: 72, type: "ui", color: "#4CAF50", visible: true, health: "active", port: 8080 },
                    { id: "runner", label: "Runner", ring: 1, angle: 144, type: "infra", color: "#FF9800", visible: true, health: "active" },
                    { id: "chromadb", label: "ChromaDB", ring: 1, angle: 216, type: "data", color: "#9C27B0", visible: true, health: "active", port: 8000 },
                    { id: "mcp", label: "MCP Server", ring: 1, angle: 288, type: "bridge", color: "#2196F3", visible: true, health: "active" },
                    { id: "foundry", label: "Foundry", ring: 2, angle: 30, type: "ai", color: "#00BCD4", visible: true, health: "pending", port: 5272 },
                    { id: "k8s", label: "Kubernetes", ring: 2, angle: 90, type: "infra", color: "#326CE5", visible: true, health: "pending" },
                    { id: "agent-router", label: "Agent Router", ring: 2, angle: 150, type: "ai", color: "#E91E63", visible: true, health: "active", port: 8081 },
                    { id: "autonomous", label: "Auto Loop", ring: 2, angle: 210, type: "ai", color: "#FF5722", visible: true, health: "active", port: 8082 },
                    { id: "workflow", label: "Workflow", ring: 2, angle: 270, type: "infra", color: "#795548", visible: true, health: "active", port: 8084 },
                    { id: "gpu-mgr", label: "GPU Manager", ring: 2, angle: 330, type: "hardware", color: "#76B900", visible: true, health: "active" },
                    { id: "tokens", label: "Token System", ring: 2, angle: 0, type: "security", color: "#FFC107", visible: true, health: "active" },
                    { id: "trellis", label: "TRELLIS.2", ring: 3, angle: 45, type: "ai", color: "#00E676", visible: true, health: "pending", port: 8085 },
                    { id: "graphrag", label: "GraphRAG", ring: 3, angle: 135, type: "data", color: "#7C4DFF", visible: true, health: "pending" },
                    { id: "llmlingua", label: "LLMLingua", ring: 3, angle: 225, type: "ai", color: "#FF6D00", visible: true, health: "pending" },
                    { id: "brand", label: "Brand System", ring: 3, angle: 315, type: "identity", color: "#D4785A", visible: true, health: "active" }
                ],
                connections: [
                    { from: "core", to: "ollama", type: "data", active: true },
                    { from: "core", to: "dashboard", type: "data", active: true },
                    { from: "core", to: "runner", type: "control", active: true },
                    { from: "core", to: "chromadb", type: "data", active: true },
                    { from: "core", to: "mcp", type: "control", active: true },
                    { from: "ollama", to: "dashboard", type: "status", active: true },
                    { from: "runner", to: "dashboard", type: "status", active: true },
                    { from: "chromadb", to: "ollama", type: "data", active: true },
                    { from: "ollama", to: "foundry", type: "fallback", active: true },
                    { from: "runner", to: "k8s", type: "deploy", active: true },
                    { from: "core", to: "agent-router", type: "control", active: true },
                    { from: "agent-router", to: "autonomous", type: "task", active: true },
                    { from: "runner", to: "workflow", type: "control", active: true },
                    { from: "runner", to: "gpu-mgr", type: "hardware", active: true },
                    { from: "core", to: "tokens", type: "auth", active: true },
                    { from: "autonomous", to: "workflow", type: "task", active: true },
                    { from: "gpu-mgr", to: "ollama", type: "hardware", active: true },
                    { from: "tokens", to: "mcp", type: "auth", active: true },
                    { from: "k8s", to: "trellis", type: "deploy", active: true },
                    { from: "chromadb", to: "graphrag", type: "data", active: true },
                    { from: "ollama", to: "llmlingua", type: "optimize", active: true },
                    { from: "core", to: "brand", type: "identity", active: true }
                ]
            };

            // ── SVG Setup ────────────────────────────────────────────────────
            var svg = document.getElementById('avatar-svg');
            var width = window.innerWidth;
            var height = window.innerHeight;
            var cx = width / 2;
            var cy = height / 2;

            svg.setAttribute('viewBox', '0 0 ' + width + ' ' + height);

            // ── Defs: gradients, filters ────────────────────────────────────
            var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

            // Core glow filter
            defs.innerHTML = '<filter id="glow" x="-50%" y="-50%" width="200%" height="200%">' +
                '<feGaussianBlur stdDeviation="4" result="blur"/>' +
                '<feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>' +
                '</filter>' +
                '<filter id="glow-strong" x="-50%" y="-50%" width="200%" height="200%">' +
                '<feGaussianBlur stdDeviation="8" result="blur"/>' +
                '<feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>' +
                '</filter>' +
                '<radialGradient id="core-gradient" cx="50%" cy="50%" r="50%">' +
                '<stop offset="0%" stop-color="#D4785A" stop-opacity="0.8"/>' +
                '<stop offset="70%" stop-color="#B85A3C" stop-opacity="0.4"/>' +
                '<stop offset="100%" stop-color="#8B4530" stop-opacity="0"/>' +
                '</radialGradient>';
            svg.appendChild(defs);

            // ── Draw ring guides ────────────────────────────────────────────
            var ringGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            ringGroup.setAttribute('class', 'rings');

            var ringRadii = [120, 220, 320];
            ringRadii.forEach(function (r) {
                var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', cx);
                circle.setAttribute('cy', cy);
                circle.setAttribute('r', r);
                circle.setAttribute('fill', 'none');
                circle.setAttribute('stroke', 'rgba(27,58,75,0.4)');
                circle.setAttribute('stroke-width', '1');
                circle.setAttribute('stroke-dasharray', '4 8');
                ringGroup.appendChild(circle);
            });
            svg.appendChild(ringGroup);

            // ── Core glow ───────────────────────────────────────────────────
            var coreGlow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            coreGlow.setAttribute('cx', cx);
            coreGlow.setAttribute('cy', cy);
            coreGlow.setAttribute('r', '60');
            coreGlow.setAttribute('fill', 'url(#core-gradient)');
            svg.appendChild(coreGlow);

            // ── Position nodes ──────────────────────────────────────────────
            var nodeMap = {};
            var visibleNodes = AVATAR.nodes.filter(function (n) { return n.visible; });

            visibleNodes.forEach(function (node) {
                var ringRadius = node.ring === 0 ? 0 : ringRadii[node.ring - 1];
                var angleRad = (node.angle - 90) * Math.PI / 180;  // -90 so 0deg = top
                node.x = cx + ringRadius * Math.cos(angleRad);
                node.y = cy + ringRadius * Math.sin(angleRad);
                node.baseX = node.x;
                node.baseY = node.y;
                nodeMap[node.id] = node;
            });

            // ── Draw connections ────────────────────────────────────────────
            var connGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            connGroup.setAttribute('class', 'connections');

            AVATAR.connections.forEach(function (conn, i) {
                if (!conn.active) return;
                var fromNode = nodeMap[conn.from];
                var toNode = nodeMap[conn.to];
                if (!fromNode || !toNode) return;

                var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', fromNode.x);
                line.setAttribute('y1', fromNode.y);
                line.setAttribute('x2', toNode.x);
                line.setAttribute('y2', toNode.y);
                line.setAttribute('stroke', 'rgba(79,195,247,0.15)');
                line.setAttribute('stroke-width', '1.5');
                line.setAttribute('stroke-dasharray', '6 4');
                line.setAttribute('data-conn-idx', i);
                connGroup.appendChild(line);
            });
            svg.appendChild(connGroup);

            // ── Draw nodes ──────────────────────────────────────────────────
            var nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            nodeGroup.setAttribute('class', 'nodes');

            var tooltip = document.getElementById('tooltip');
            var tooltipLabel = document.getElementById('tooltip-label');
            var tooltipDetail = document.getElementById('tooltip-detail');

            visibleNodes.forEach(function (node) {
                var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('data-node-id', node.id);
                g.style.cursor = 'pointer';

                // Node radius based on ring
                var r = node.ring === 0 ? 28 : (node.ring === 1 ? 18 : (node.ring === 2 ? 14 : 12));

                // Outer glow for active nodes
                if (node.health === 'active') {
                    var glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    glow.setAttribute('cx', node.x);
                    glow.setAttribute('cy', node.y);
                    glow.setAttribute('r', r + 6);
                    glow.setAttribute('fill', node.color);
                    glow.setAttribute('opacity', '0.15');
                    glow.setAttribute('filter', 'url(#glow)');
                    g.appendChild(glow);
                }

                // Main circle
                var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', node.x);
                circle.setAttribute('cy', node.y);
                circle.setAttribute('r', r);
                circle.setAttribute('fill', node.ring === 0 ? 'rgba(184,90,60,0.3)' : 'rgba(13,27,42,0.8)');
                circle.setAttribute('stroke', node.color);
                circle.setAttribute('stroke-width', node.ring === 0 ? '3' : '2');
                if (node.health === 'active') {
                    circle.setAttribute('filter', 'url(#glow)');
                }
                g.appendChild(circle);

                // Health jewel (small dot at top-right)
                if (node.ring > 0) {
                    var jewel = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    var jewelColor = node.health === 'active' ? '#4CAF50' :
                        node.health === 'pending' ? '#FF9800' :
                            node.health === 'error' ? '#F44336' : '#616161';
                    jewel.setAttribute('cx', node.x + r * 0.65);
                    jewel.setAttribute('cy', node.y - r * 0.65);
                    jewel.setAttribute('r', '4');
                    jewel.setAttribute('fill', jewelColor);
                    jewel.setAttribute('stroke', 'rgba(13,27,42,0.8)');
                    jewel.setAttribute('stroke-width', '1.5');
                    g.appendChild(jewel);
                }

                // Label
                var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x);
                text.setAttribute('y', node.y + r + 16);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'rgba(232,226,222,0.7)');
                text.setAttribute('font-size', node.ring === 0 ? '13' : '10');
                text.setAttribute('font-family', "'Segoe UI', 'Inter', system-ui, sans-serif");
                text.setAttribute('font-weight', node.ring === 0 ? '700' : '500');
                text.textContent = node.label;
                g.appendChild(text);

                // Core hexagon label
                if (node.ring === 0) {
                    var coreLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    coreLabel.setAttribute('x', node.x);
                    coreLabel.setAttribute('y', node.y + 4);
                    coreLabel.setAttribute('text-anchor', 'middle');
                    coreLabel.setAttribute('fill', '#D4785A');
                    coreLabel.setAttribute('font-size', '11');
                    coreLabel.setAttribute('font-family', "'Consolas', 'JetBrains Mono', monospace");
                    coreLabel.setAttribute('font-weight', '700');
                    coreLabel.textContent = 'v3.0.0';
                    g.appendChild(coreLabel);
                }

                // Hover events
                g.addEventListener('mouseenter', function (e) {
                    var portStr = node.port ? 'Port: ' + node.port : 'Internal';
                    tooltipLabel.textContent = node.label;
                    tooltipDetail.innerHTML = 'Ring: ' + node.ring + ' | Type: ' + node.type +
                        '<br>' + portStr + ' | Health: ' + node.health;
                    tooltip.classList.add('visible');
                });

                g.addEventListener('mousemove', function (e) {
                    tooltip.style.left = (e.clientX + 16) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                g.addEventListener('mouseleave', function () {
                    tooltip.classList.remove('visible');
                });

                nodeGroup.appendChild(g);
            });
            svg.appendChild(nodeGroup);

            // ── Animation: Orbit and flow ───────────────────────────────────
            var orbitAngle = 0;
            var flowOffset = 0;
            var orbitSpeed = AVATAR.orbit_speed;

            function animate() {
                orbitAngle += orbitSpeed * 0.15;
                flowOffset += 0.5;

                // Orbit nodes slightly
                visibleNodes.forEach(function (node) {
                    if (node.ring === 0) return;
                    var orbitOffset = orbitAngle * (0.5 / node.ring);
                    var angleRad = ((node.angle + orbitOffset) - 90) * Math.PI / 180;
                    var ringRadius = ringRadii[node.ring - 1];
                    node.x = cx + ringRadius * Math.cos(angleRad);
                    node.y = cy + ringRadius * Math.sin(angleRad);
                });

                // Update node positions
                var nodeElements = nodeGroup.querySelectorAll('g[data-node-id]');
                nodeElements.forEach(function (g) {
                    var nodeId = g.getAttribute('data-node-id');
                    var node = nodeMap[nodeId];
                    if (!node || node.ring === 0) return;

                    var circles = g.querySelectorAll('circle');
                    var texts = g.querySelectorAll('text');
                    var r = node.ring === 1 ? 18 : (node.ring === 2 ? 14 : 12);

                    circles.forEach(function (c, i) {
                        c.setAttribute('cx', i === 2 ? node.x + r * 0.65 : node.x);
                        c.setAttribute('cy', i === 2 ? node.y - r * 0.65 : node.y);
                    });

                    texts.forEach(function (t) {
                        t.setAttribute('x', node.x);
                        t.setAttribute('y', node.y + r + 16);
                    });
                });

                // Update connection lines
                var connLines = connGroup.querySelectorAll('line');
                connLines.forEach(function (line) {
                    var idx = parseInt(line.getAttribute('data-conn-idx'));
                    var conn = AVATAR.connections[idx];
                    if (!conn) return;
                    var fromNode = nodeMap[conn.from];
                    var toNode = nodeMap[conn.to];
                    if (!fromNode || !toNode) return;
                    line.setAttribute('x1', fromNode.x);
                    line.setAttribute('y1', fromNode.y);
                    line.setAttribute('x2', toNode.x);
                    line.setAttribute('y2', toNode.y);
                    line.setAttribute('stroke-dashoffset', flowOffset);
                });

                // Core pulse
                var pulseScale = 1 + Math.sin(orbitAngle * 0.05) * 0.1;
                coreGlow.setAttribute('r', 60 * pulseScale);

                requestAnimationFrame(animate);
            }

            animate();

            // ── Resize handler ──────────────────────────────────────────────
            window.addEventListener('resize', function () {
                width = window.innerWidth;
                height = window.innerHeight;
                cx = width / 2;
                cy = height / 2;
                svg.setAttribute('viewBox', '0 0 ' + width + ' ' + height);

                // Re-center ring guides
                var ringCircles = ringGroup.querySelectorAll('circle');
                ringCircles.forEach(function (c) {
                    c.setAttribute('cx', cx);
                    c.setAttribute('cy', cy);
                });

                // Re-center core glow
                coreGlow.setAttribute('cx', cx);
                coreGlow.setAttribute('cy', cy);

                // Re-position core node
                var coreNode = nodeMap['core'];
                if (coreNode) {
                    coreNode.x = cx;
                    coreNode.y = cy;
                    coreNode.baseX = cx;
                    coreNode.baseY = cy;
                }
            });

        })();
    </script>
</body>

</html>