<!DOCTYPE html>
<html lang="en">
<!-- Modified: 2026-02-06T19:00:00Z | Author: COPILOT | Change: SLATE install progress dashboard -->
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>S.L.A.T.E. — Installation</title>
<style>
/* ═══ SLATE Install Dashboard — Dark Glass Theme ═══ */
:root {
  --bg-root: #08090b;
  --bg-card: #111114;
  --bg-card-active: #13111f;
  --bg-glass: rgba(17,17,20,0.85);
  --border: #1e1e24;
  --border-active: #a78bfa60;
  --text: #d4d4d8;
  --text-dim: #71717a;
  --text-bright: #fafafa;
  --accent: #a78bfa;
  --accent2: #818cf8;
  --success: #22c55e;
  --error: #ef4444;
  --warning: #eab308;
  --skip: #6b7280;
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 15px; }

body {
  background: var(--bg-root);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 2rem 1rem;
  overflow-x: hidden;
}

/* ═══ Header ═══ */
.header {
  text-align: center;
  margin-bottom: 2rem;
  animation: fadeIn 0.6s ease;
}
.header h1 {
  font-size: 1.75rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.25rem;
}
.header .version {
  font-size: 0.8rem;
  color: var(--text-dim);
  font-family: var(--mono);
}
.header .subtitle {
  font-size: 0.9rem;
  color: var(--text-dim);
  margin-top: 0.5rem;
}

/* ═══ Main Container ═══ */
.main {
  max-width: 720px;
  width: 100%;
}

/* ═══ System Info Bar ═══ */
.sys-info {
  display: flex;
  gap: 1.5rem;
  flex-wrap: wrap;
  padding: 0.75rem 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 1.5rem;
  font-size: 0.78rem;
  font-family: var(--mono);
  color: var(--text-dim);
}
.sys-info .chip {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.sys-info .chip .label { color: var(--text-dim); }
.sys-info .chip .value { color: var(--text); font-weight: 500; }

/* ═══ Progress Overview ═══ */
.progress-overview {
  margin-bottom: 1.5rem;
}
.progress-track {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}
.progress-track-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2), var(--success));
  border-radius: 3px;
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  width: 0%;
}
.progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.78rem;
  color: var(--text-dim);
}

/* ═══ Steps ═══ */
.steps-container {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}
.step {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.85rem 1rem;
  border-radius: 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  transition: all 0.35s ease;
  position: relative;
  overflow: hidden;
}
.step::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  border-radius: 3px 0 0 3px;
  background: transparent;
  transition: background 0.3s;
}

/* Step states */
.step.running {
  border-color: var(--border-active);
  background: var(--bg-card-active);
  box-shadow: 0 0 20px rgba(167, 139, 250, 0.06);
}
.step.running::before { background: var(--accent); }
.step.success::before { background: var(--success); }
.step.failed::before { background: var(--error); }
.step.warning::before { background: var(--warning); }

/* Step icon */
.step-icon {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  flex-shrink: 0;
  transition: all 0.3s;
}
.step-icon.pending { background: #27272a; color: #52525b; }
.step-icon.running { background: rgba(167,139,250,0.15); color: var(--accent); }
.step-icon.success { background: rgba(34,197,94,0.12); color: var(--success); }
.step-icon.failed  { background: rgba(239,68,68,0.12); color: var(--error); }
.step-icon.warning { background: rgba(234,179,8,0.12); color: var(--warning); }
.step-icon.skipped { background: #27272a; color: var(--skip); }

/* Pulse animation for running icon */
.step-icon.running {
  animation: iconPulse 1.8s cubic-bezier(0.4,0,0.6,1) infinite;
}

/* Step content */
.step-content { flex: 1; min-width: 0; }
.step-name {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-bright);
  margin-bottom: 2px;
}
.step-detail {
  font-size: 0.75rem;
  color: var(--text-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.step-detail.error { color: var(--error); }

/* Step progress bar */
.step-progress {
  height: 3px;
  background: #27272a;
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.step-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 2px;
  transition: width 0.5s ease;
}

/* Step duration badge */
.step-duration {
  font-size: 0.7rem;
  font-family: var(--mono);
  color: var(--text-dim);
  flex-shrink: 0;
  padding: 0.2rem 0.5rem;
  background: #1a1a1e;
  border-radius: 4px;
}

/* ═══ Summary Card ═══ */
.summary-card {
  padding: 1.25rem;
  border-radius: 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  margin-bottom: 1.5rem;
  transition: border-color 0.3s;
}
.summary-card.complete { border-color: rgba(34,197,94,0.3); }
.summary-card.failed   { border-color: rgba(239,68,68,0.3); }

.summary-title {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.5rem;
}
.summary-detail {
  font-size: 0.8rem;
  color: var(--text-dim);
  line-height: 1.6;
}
.summary-git {
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 1.5rem;
  font-size: 0.75rem;
  font-family: var(--mono);
  color: var(--text-dim);
}

/* ═══ Log Panel ═══ */
.log-panel {
  border-radius: 10px;
  background: #0a0a0c;
  border: 1px solid var(--border);
  overflow: hidden;
}
.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.65rem 1rem;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--text-dim);
}
.log-body {
  max-height: 240px;
  overflow-y: auto;
  padding: 0.75rem 1rem;
  font-family: var(--mono);
  font-size: 0.72rem;
  line-height: 1.7;
  color: var(--text-dim);
}
.log-body .line { white-space: nowrap; }
.log-body .line:has(.ok) { color: var(--success); }
.log-body .line:has(.err) { color: var(--error); }

/* ═══ Scrollbar ═══ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

/* ═══ Animations ═══ */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes iconPulse { 0%,100% { opacity: 1; box-shadow: 0 0 0 0 rgba(167,139,250,0.3); } 50% { opacity: 0.7; box-shadow: 0 0 0 8px rgba(167,139,250,0); } }

/* ═══ Responsive ═══ */
@media (max-width: 500px) {
  html { font-size: 14px; }
  .sys-info { flex-direction: column; gap: 0.5rem; }
  .step-duration { display: none; }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>S.L.A.T.E.</h1>
  <div class="version" id="versionBadge">v?.?.?</div>
  <div class="subtitle">System Learning Agent for Task Execution — Installing</div>
</div>

<div class="main">

  <!-- System Info -->
  <div class="sys-info" id="sysInfo">
    <div class="chip"><span class="label">Platform:</span> <span class="value" id="siPlatform">—</span></div>
    <div class="chip"><span class="label">Python:</span> <span class="value" id="siPython">—</span></div>
    <div class="chip"><span class="label">RAM:</span> <span class="value" id="siRam">—</span></div>
    <div class="chip"><span class="label">Branch:</span> <span class="value" id="siBranch">—</span></div>
    <div class="chip"><span class="label">Commit:</span> <span class="value" id="siCommit">—</span></div>
  </div>

  <!-- Overall Progress -->
  <div class="progress-overview">
    <div class="progress-track">
      <div class="progress-track-fill" id="overallFill"></div>
    </div>
    <div class="progress-label">
      <span id="progressText">0 / 10 steps</span>
      <span id="progressPct">0%</span>
    </div>
  </div>

  <!-- Steps -->
  <div class="steps-container" id="stepsContainer">
    <!-- populated by JS -->
  </div>

  <!-- Summary -->
  <div class="summary-card" id="summaryCard">
    <div class="summary-title" id="summaryTitle">Waiting for installation...</div>
    <div class="summary-detail" id="summaryDetail">The SLATE Dashboard is the first system to come online during installation. Once the installer starts, each step will appear here in real-time.</div>
    <div class="summary-git" id="summaryGit" style="display:none">
      <span id="gitRemote"></span>
    </div>
  </div>

  <!-- Log -->
  <div class="log-panel">
    <div class="log-header">
      <span>Install Log</span>
      <span id="logCount">0 entries</span>
    </div>
    <div class="log-body" id="logBody">
      <div class="line" style="color:var(--text-dim)">Waiting for install events...</div>
    </div>
  </div>

</div>

<script>
// ═══ SLATE Install Dashboard — Client Logic ═══

const ICONS = {
  pending: '○', running: '◉', success: '✓',
  failed: '✗', warning: '⚠', skipped: '–'
};

let currentState = null;
let isConnected = false;

// ─── Render Functions ───

function renderSysInfo(si, gi) {
  if (si) {
    document.getElementById('siPlatform').textContent = si.platform || '—';
    document.getElementById('siPython').textContent = si.python_version || '—';
    document.getElementById('siRam').textContent = si.ram_total_gb ? si.ram_total_gb + ' GB' : '—';
  }
  if (gi) {
    document.getElementById('siBranch').textContent = gi.branch || '—';
    document.getElementById('siCommit').textContent = gi.commit || '—';
  }
}

function renderSteps(steps) {
  const container = document.getElementById('stepsContainer');
  container.innerHTML = steps.map(s => {
    const dur = s.duration_ms ? formatDuration(s.duration_ms) : '';
    const detail = s.error || s.details || s.description || '';
    const detailClass = s.error ? 'error' : '';
    return `
      <div class="step ${s.status}" data-step="${s.id}">
        <div class="step-icon ${s.status}">${ICONS[s.status] || '○'}</div>
        <div class="step-content">
          <div class="step-name">${s.name}</div>
          <div class="step-detail ${detailClass}">${detail}</div>
          ${s.status === 'running' ? `<div class="step-progress"><div class="step-progress-fill" style="width:${s.progress_pct || 10}%"></div></div>` : ''}
        </div>
        ${dur ? `<div class="step-duration">${dur}</div>` : ''}
      </div>
    `;
  }).join('');
}

function renderOverallProgress(steps) {
  const total = steps.length;
  const done = steps.filter(s => ['success','warning','skipped'].includes(s.status)).length;
  const pct = total > 0 ? Math.round((done / total) * 100) : 0;
  document.getElementById('overallFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${done} / ${total} steps`;
  document.getElementById('progressPct').textContent = pct + '%';
}

function renderSummary(st) {
  const card = document.getElementById('summaryCard');
  const title = document.getElementById('summaryTitle');
  const detail = document.getElementById('summaryDetail');
  const gitDiv = document.getElementById('summaryGit');

  card.className = 'summary-card';

  if (st.status === 'not_started') {
    title.textContent = 'Waiting for installation...';
    detail.textContent = 'The SLATE Dashboard is the first system to come online. Once the installer starts, progress will appear here in real-time.';
    return;
  }
  if (st.status === 'in_progress') {
    const current = st.steps.find(s => s.status === 'running');
    title.innerHTML = '◉ Installing...';
    detail.textContent = current ? `Current: ${current.name}` : 'Processing...';
    return;
  }
  if (st.status === 'completed') {
    card.classList.add('complete');
    const ok = st.steps.filter(s => s.status === 'success').length;
    const warn = st.steps.filter(s => s.status === 'warning').length;
    title.innerHTML = '<span style="color:var(--success)">✓ Installation Complete</span>';
    detail.innerHTML = `SLATE v${st.slate_version || '?'} — ${ok} passed` + (warn ? `, ${warn} warnings` : '') + `<br>Ready to use: <code>python slate/slate_status.py --quick</code>`;
  } else {
    card.classList.add('failed');
    const fail = st.steps.filter(s => s.status === 'failed').length;
    title.innerHTML = '<span style="color:var(--error)">✗ Installation Failed</span>';
    const errors = st.errors || [];
    detail.innerHTML = `${fail} step(s) failed` + (errors.length ? `: ${errors.map(e=>e.error).join(', ')}` : '');
  }

  // Git info
  if (st.git_info && st.git_info.remote) {
    gitDiv.style.display = 'flex';
    document.getElementById('gitRemote').textContent = st.git_info.remote;
  }
}

function renderLog(lines) {
  const body = document.getElementById('logBody');
  const count = document.getElementById('logCount');
  if (!lines || lines.length === 0) return;
  body.innerHTML = lines.map(l => {
    let cls = '';
    if (l.includes('[OK]') || l.includes('✓')) cls = 'ok';
    if (l.includes('[ERROR]') || l.includes('✗')) cls = 'err';
    return `<div class="line"><span class="${cls}">${escHtml(l)}</span></div>`;
  }).join('');
  count.textContent = lines.length + ' entries';
  body.scrollTop = body.scrollHeight;
}

function renderVersion(st) {
  document.getElementById('versionBadge').textContent = st.slate_version ? `v${st.slate_version}` : 'v?.?.?';
}

// ─── Helpers ───

function formatDuration(ms) {
  if (ms < 1000) return ms + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ─── Data Flow ───

function applyState(st) {
  currentState = st;
  if (st.system_info || st.git_info) renderSysInfo(st.system_info, st.git_info);
  if (st.steps && st.steps.length > 0) {
    renderSteps(st.steps);
    renderOverallProgress(st.steps);
  }
  renderSummary(st);
  renderVersion(st);
  if (st.log) renderLog(st.log);
}

async function poll() {
  try {
    const r = await fetch('/api/install/status');
    if (r.ok) {
      const st = await r.json();
      applyState(st);
    }
  } catch(e) { /* dashboard not ready yet */ }
}

// ─── SSE Connection ───

function connectSSE() {
  let es;
  try {
    es = new EventSource('/api/install/events');
  } catch(e) {
    fallbackToPolling();
    return;
  }

  es.addEventListener('init', e => {
    try {
      const st = JSON.parse(e.data);
      applyState(st);
      isConnected = true;
    } catch(err) {}
  });

  es.addEventListener('update', e => {
    // Re-poll on any update to get fresh state
    poll();
  });

  es.addEventListener('ping', () => {});

  es.onerror = () => {
    es.close();
    isConnected = false;
    fallbackToPolling();
  };
}

function fallbackToPolling() {
  setInterval(poll, 2000);
}

// ─── Init ───

// Initial poll
poll();

// Try SSE, fall back to polling
try {
  connectSSE();
} catch(e) {
  fallbackToPolling();
}

// Also poll periodically as backup
setInterval(poll, 3000);
</script>
</body>
</html>
