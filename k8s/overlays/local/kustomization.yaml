# Modified: 2026-02-08T07:10:00Z | Author: COPILOT | Change: Create Kustomize local overlay for Docker Desktop K8s / minikube / k3s
# Modified: 2026-02-09T10:00:00Z | Author: COPILOT | Change: Add instruction-controller, HPA, PDB, ingress resources to local overlay
# Modified: 2026-02-08T23:15:00Z | Author: COPILOT | Change: Document --load-restrictor flag required for cross-directory references
# SLATE Local Overlay — Kustomize
#
# Adapts the base K8s manifests for local development:
#   - Local images (built locally, never pulled from ghcr.io)
#   - hostPath volumes (mount workspace directly from host)
#   - Relaxed GPU nodeSelector (Docker Desktop K8s doesn't label GPU nodes)
#   - Dev mode config
#
# Deploy:  kubectl kustomize k8s/overlays/local/ --load-restrictor LoadRestrictionsNone | kubectl apply -f -
# Teardown: kubectl kustomize k8s/overlays/local/ --load-restrictor LoadRestrictionsNone | kubectl delete -f -
# NOTE: --load-restrictor is required because overlay references base files via ../../
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: slate

# Modified: 2026-02-08T23:15:00Z | Author: COPILOT | Change: Explicit base file references to avoid kustomize cycle detection
resources:
  - ../../namespace.yaml
  - ../../rbac.yaml
  - ../../network-policy.yaml
  - ../../secrets.yaml
  - ../../slate-instructions.yaml
  - ../../instruction-controller.yaml
  - ../../deployments.yaml
  - ../../slate-dashboard.yaml
  - ../../hpa-monitoring.yaml
  - ../../pdb.yaml
  - ../../agentic-system.yaml
  - ../../ml-pipeline.yaml
  - ../../runners.yaml
  - ../../ingress-gpu.yaml
  - local-storage.yaml

# Override base storage with local hostPath volumes
# (local-storage.yaml provides PVs; we don't need the base PVCs since we redefine them)

patches:
  # ── slate-core: use local image, remove GPU nodeSelector ──
  - target:
      kind: Deployment
      name: slate-core
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: slate-core
      spec:
        template:
          spec:
            # Remove GPU nodeSelector for local K8s
            nodeSelector: null
            tolerations: []
            containers:
              - name: slate
                # Use locally-built image
                image: slate:local
                imagePullPolicy: Never
                env:
                  - name: SLATE_MODE
                    value: dev
                  - name: SLATE_WORKSPACE
                    value: /workspace
                  - name: OLLAMA_HOST
                    value: ollama-svc:11434
                  - name: PYTHONPATH
                    value: /slate:/workspace
                  - name: SLATE_K8S
                    value: "true"
                resources:
                  requests:
                    cpu: 250m
                    memory: 512Mi
                  limits:
                    cpu: 2000m
                    memory: 4Gi
                    # GPU limit removed — NVIDIA device plugin handles it if present

  # ── ollama: remove GPU nodeSelector for local ──
  - target:
      kind: Deployment
      name: ollama
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ollama
      spec:
        template:
          spec:
            nodeSelector: null
            tolerations: []
            containers:
              - name: ollama
                image: ollama/ollama:latest
                imagePullPolicy: IfNotPresent
                resources:
                  requests:
                    cpu: 500m
                    memory: 4Gi
                  limits:
                    cpu: 4000m
                    memory: 16Gi
                    # GPU assigned automatically by NVIDIA runtime if available

  # ── chromadb: use IfNotPresent for local caching ──
  - target:
      kind: Deployment
      name: chromadb
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: chromadb
      spec:
        template:
          spec:
            containers:
              - name: chromadb
                imagePullPolicy: IfNotPresent

  # ── instruction-controller: use local image, never pull ──
  - target:
      kind: Deployment
      name: slate-instruction-controller
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: slate-instruction-controller
      spec:
        template:
          spec:
            containers:
              - name: controller
                image: slate:local
                imagePullPolicy: Never

  # ── instruction-sync CronJob: use local image ──
  - target:
      kind: CronJob
      name: slate-instruction-sync
    patch: |
      apiVersion: batch/v1
      kind: CronJob
      metadata:
        name: slate-instruction-sync
      spec:
        jobTemplate:
          spec:
            template:
              spec:
                containers:
                  - name: sync
                    image: slate:local
                    imagePullPolicy: Never

  # ── agent-router: local image ──
  - target:
      kind: Deployment
      name: slate-agent-router
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: slate-agent-router
      spec:
        template:
          spec:
            containers:
              - name: router
                image: slate:local
                imagePullPolicy: Never

  # ── autonomous-loop: local image ──
  - target:
      kind: Deployment
      name: slate-autonomous-loop
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: slate-autonomous-loop
      spec:
        template:
          spec:
            containers:
              - name: autonomous
                image: slate:local
                imagePullPolicy: Never

  # ── copilot-bridge: local image ──
  - target:
      kind: Deployment
      name: slate-copilot-bridge
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: slate-copilot-bridge
      spec:
        template:
          spec:
            containers:
              - name: bridge
                image: slate:local
                imagePullPolicy: Never

  # ── workflow-manager: local image ──
  - target:
      kind: Deployment
      name: slate-workflow-manager
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: slate-workflow-manager
      spec:
        template:
          spec:
            containers:
              - name: workflow
                image: slate:local
                imagePullPolicy: Never

commonLabels:
  app.kubernetes.io/managed-by: slate
  app.kubernetes.io/version: "2.4.0"
  slate.io/environment: local

commonAnnotations:
  slate.io/overlay: local
  slate.io/security-policy: restricted
