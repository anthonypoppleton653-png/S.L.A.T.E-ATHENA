# Modified: 2026-02-07T04:56:45Z | Author: COPILOT | Change: Normalize paths and clean workflow artifacts
# Contributor PR Workflow
# Handles PRs from external SLATE users (forks of the public repo).

name: Contributor PR

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main]

# Modified: 2026-02-07T08:30:00Z | Author: COPILOT | Change: Add concurrency block per GitHub docs
concurrency:
  group: contributor-pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

defaults:
  run:
    shell: powershell

jobs:
  detect-contributor:
    name: Detect Contributor Type
    runs-on: [self-hosted, slate]
    outputs:
      is_fork: ${{ steps.check.outputs.is_fork }}
      is_trusted: ${{ steps.check.outputs.is_trusted }}
      contributor: ${{ steps.check.outputs.contributor }}
    steps:
      - name: Analyze PR source
        id: check
        run: |
          $isFork = "${{ github.event.pull_request.head.repo.fork }}"
          $contributor = "${{ github.event.pull_request.user.login }}"
          $trustedUsers = @("SynchronizedLivingArchitecture", "SLATE-BETA")
          $isTrusted = if ($trustedUsers -contains $contributor) { "true" } else { "false" }

          "is_fork=$isFork" | Out-File -Append $env:GITHUB_OUTPUT
          "is_trusted=$isTrusted" | Out-File -Append $env:GITHUB_OUTPUT
          "contributor=$contributor" | Out-File -Append $env:GITHUB_OUTPUT

          Write-Host "::notice::Contributor: $contributor, Fork: $isFork, Trusted: $isTrusted"

  welcome-contributor:
    name: Welcome Contributor
    needs: detect-contributor
    if: needs.detect-contributor.outputs.is_fork == 'true'
    runs-on: [self-hosted, slate]
    steps:
      - name: Check if first contribution
        id: first_time
        uses: actions/github-script@v8
        with:
          script: |
            const contributor = '${{ needs.detect-contributor.outputs.contributor }}';
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            const previousPRs = prs.data.filter(pr =>
              pr.user.login === contributor && pr.number !== context.issue.number
            );
            core.setOutput('is_first', previousPRs.length === 0);
            return previousPRs.length === 0;

      - name: Post welcome message
        if: steps.first_time.outputs.is_first == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const message = `## Welcome to SLATE!\n\nThank you for your first contribution, @${{ needs.detect-contributor.outputs.contributor }}!\n\n### What happens next:\n1. **Automated checks** will validate your changes against SLATE standards\n2. **Security scan** will ensure no harmful patterns are introduced\n3. **A maintainer** will review your PR once checks pass\n\n### SLATE Contributor Guidelines:\n- All code must bind to \`127.0.0.1\` only (no \`0.0.0.0\`)\n- ActionGuard must remain intact\n- Tests are required for new features\n- Follow the existing code style\n\n### Need help?\n- Check our [wiki](../../wiki) for documentation\n- Review [CONTRIBUTING.md](../../blob/main/CONTRIBUTING.md)\n\n---\n*SLATE Contributor Bot*`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  validate-contribution:
    name: Validate Contribution
    needs: detect-contributor
    runs-on: [self-hosted, slate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH
      - name: Install dependencies
        run: pip install -r requirements.txt 2>$null
        continue-on-error: true
      - name: Validate SLATE core modules
        run: |
          python -c @"
          import sys
          errors = []
          modules = ['slate', 'slate.slate_status', 'slate.action_guard']
          for mod in modules:
              try:
                  __import__(mod)
                  print(f'OK: {mod}')
              except Exception as e:
                  print(f'FAIL: {mod} - {e}')
                  errors.append(mod)
          if errors:
              print(f'::error::Missing modules: {errors}')
              sys.exit(1)
          "@
        continue-on-error: true
      - name: Check for protected file modifications
        if: needs.detect-contributor.outputs.is_fork == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $headers = @{ Authorization = "token $env:GH_TOKEN"; Accept = "application/vnd.github.v3+json" }
          $files = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" -Headers $headers
          $changedFiles = $files | ForEach-Object { $_.filename }
          $protected = @(".github/workflows", ".github/CODEOWNERS", "slate/action_guard.py")
          foreach ($p in $protected) {
            $match = $changedFiles | Where-Object { $_ -like "$p*" }
            if ($match) {
              Write-Host "::error::Cannot modify protected file: $p"
              exit 1
            }
          }
          Write-Host "No protected files modified"

      - name: Security scan
        run: |
          $patterns = @("0.0.0.0", "eval\(", "exec\(os", "subprocess\.call.*shell=True")
          foreach ($pattern in $patterns) {
            $found = Get-ChildItem -Recurse -Include "*.py" -Path slate,agents -ErrorAction SilentlyContinue |
              Select-String -Pattern $pattern -ErrorAction SilentlyContinue |
              Where-Object { $_.Line -notmatch "test" } | Select-Object -First 3
            if ($found) {
              Write-Host "::warning::Found potentially dangerous pattern: $pattern"
              $found | ForEach-Object { Write-Host "  $_" }
            }
          }

  label-pr:
    name: Label PR
    needs: [detect-contributor, validate-contribution]
    runs-on: [self-hosted, slate]
    if: always()
    steps:
      - name: Apply labels
        uses: actions/github-script@v8
        with:
          script: |
            const labels = [];
            if ('${{ needs.detect-contributor.outputs.is_fork }}' === 'true') labels.push('external-contributor');
            if ('${{ needs.detect-contributor.outputs.is_trusted }}' === 'true') labels.push('trusted-contributor');
            if ('${{ needs.validate-contribution.result }}' === 'success') labels.push('validation-passed');
            else labels.push('needs-fixes');
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }

  validation-summary:
    name: Validation Summary
    needs: [detect-contributor, validate-contribution]
    runs-on: [self-hosted, slate]
    if: always()
    steps:
      - name: Post validation results
        uses: actions/github-script@v8
        with:
          script: |
            const passed = '${{ needs.validate-contribution.result }}' === 'success';
            const icon = passed ? '--' : '--';
            const body = `## ${icon} Contributor Validation Results\n\n| Check | Status |\n|-------|--------|\n| Contributor Type | ${{ needs.detect-contributor.outputs.is_fork == 'true' && 'External Fork' || 'Internal' }} |\n| Trusted Status | ${{ needs.detect-contributor.outputs.is_trusted == 'true' && 'Trusted' || 'Standard Review Required' }} |\n| Validation | ${passed ? 'Passed' : 'Failed'} |\n\n${passed ? '### Ready for Review\nThis contribution has passed automated validation.' : '### Action Required\nPlease address the validation failures.'}\n\n---\n*SLATE Contributor Validation*`;
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const botComment = comments.data.find(c => c.body.includes('Contributor Validation Results'));
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
