# 
# Nightly Workflow
# Author: COPILOT | Created: 2026-01-20T00:00:00Z | Modified: 2026-02-06T14:00:00Z
# Full test suite, coverage, and SLATE health checks run nightly
# 

name: Nightly

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

concurrency:
  group: nightly
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read

jobs:
  full-test-suite:
    name: Full Test Suite
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist
      - name: Run full test suite
        run: pytest tests/ -v --tb=short --cov=aurora_core --cov-report=xml --cov-report=term-missing -x
        continue-on-error: true
      - uses: codecov/codecov-action@v5
        if: always()
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  slate-health:
    name: SLATE Health Check
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: SLATE Status
        run: python aurora_core/slate_status.py --quick
        continue-on-error: true
      - name: Validate task queue integrity
        run: |
          python -c "
          import json
          with open('current_tasks.json', 'r') as f:
              tasks = json.load(f)
          total = len(tasks)
          statuses = {}
          for t in tasks:
              s = t.get('status', 'unknown')
              statuses[s] = statuses.get(s, 0) + 1
          print('Task Queue Health:')
          for status, count in sorted(statuses.items()):
              print(f'  {status}: {count}')
          print(f'  total: {total}')
          "

  sdk-import-audit:
    name: SDK Import Audit
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: Audit all SDK module imports
        run: |
          python -c "
          import os, importlib, sys
          sdk_dir = 'aurora_core'
          passed, failed = 0, 0
          for f in sorted(os.listdir(sdk_dir)):
              if f.endswith('.py') and not f.startswith('__'):
                  mod = f'{sdk_dir}.{f[:-3]}'
                  try:
                      importlib.import_module(mod)
                      passed += 1
                  except Exception as e:
                      failed += 1
                      print(f'::warning::{mod}: {e}')
          print(f'SDK Import Audit: {passed} pass, {failed} fail')
          "

  dependency-check:
    name: Dependency Freshness
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Check outdated packages
        run: |
          pip install -r requirements.txt
          pip list --outdated --format=columns || true

  summary:
    name: Nightly Summary
    needs: [full-test-suite, slate-health, sdk-import-audit, dependency-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Nightly Run Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Full Test Suite | ${{ needs.full-test-suite.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SLATE Health | ${{ needs.slate-health.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK Import Audit | ${{ needs.sdk-import-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
