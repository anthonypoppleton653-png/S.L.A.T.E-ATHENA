# 
# Nightly Workflow
# Author: COPILOT | Created: 2026-01-20T00:00:00Z | Modified: 2026-02-09T06:55:00Z
# Full test suite, coverage, and SLATE health checks run nightly
# Includes self-hosted runner GPU tests
# 

name: Nightly

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

concurrency:
  group: nightly
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read

jobs:
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist
      - name: Run full test suite
        run: pytest tests/ -v --tb=short --cov=slate --cov-report=xml --cov-report=term-missing -x
        continue-on-error: true
      - uses: codecov/codecov-action@v5
        if: always()
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  slate-health:
    name: SLATE Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: SLATE Status
        run: python slate/slate_status.py --quick
        continue-on-error: true
      - name: Validate task queue integrity
        run: |
          python -c "
          import json
          with open('current_tasks.json', 'r') as f:
              tasks = json.load(f)
          total = len(tasks)
          statuses = {}
          for t in tasks:
              s = t.get('status', 'unknown')
              statuses[s] = statuses.get(s, 0) + 1
          print('Task Queue Health:')
          for status, count in sorted(statuses.items()):
              print(f'  {status}: {count}')
          print(f'  total: {total}')
          "

  sdk-import-audit:
    name: SDK Import Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: Audit all SDK module imports
        run: |
          python -c "
          import os, importlib, sys
          sdk_dir = 'slate'
          passed, failed = 0, 0
          for f in sorted(os.listdir(sdk_dir)):
              if f.endswith('.py') and not f.startswith('__'):
                  mod = f'{sdk_dir}.{f[:-3]}'
                  try:
                      importlib.import_module(mod)
                      passed += 1
                  except Exception as e:
                      failed += 1
                      print(f'::warning::{mod}: {e}')
          print(f'SDK Import Audit: {passed} pass, {failed} fail')
          "

  dependency-check:
    name: Dependency Freshness
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Check outdated packages
        run: |
          pip install -r requirements.txt
          pip list --outdated --format=columns || true

  summary:
    name: Nightly Summary
    needs: [full-test-suite, slate-health, sdk-import-audit, dependency-check, gpu-nightly]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Nightly Run Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Full Test Suite | ${{ needs.full-test-suite.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SLATE Health | ${{ needs.slate-health.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK Import Audit | ${{ needs.sdk-import-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GPU Nightly | ${{ needs.gpu-nightly.result }} |" >> $GITHUB_STEP_SUMMARY

  # ─── Self-Hosted Runner: Nightly GPU Tests ───────────────────────────────
  gpu-nightly:
    name: "GPU Nightly Tests (Self-Hosted)"
    runs-on: [self-hosted, slate, gpu, windows]
    timeout-minutes: 30
    continue-on-error: true  # Don't fail nightly if runner is offline
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          if (-not (Test-Path "${{ github.workspace }}")) {
            New-Item -ItemType Directory -Path "${{ github.workspace }}" -Force | Out-Null
          }

      - uses: actions/checkout@v4
        with:
          clean: true

      - name: GPU Full Test Suite
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          Write-Host "=== Nightly GPU Test Suite ===" -ForegroundColor Cyan

          # Run full test suite with GPU access
          & $python -m pytest tests/ -v --tb=short -x 2>$null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::warning::Some tests failed on GPU runner"
          }

      - name: GPU Benchmark Suite
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          if (Test-Path "slate/slate_benchmark.py") {
            & $python slate/slate_benchmark.py --json
          }

      - name: ML Orchestrator Health
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          if (Test-Path "slate/ml_orchestrator.py") {
            & $python slate/ml_orchestrator.py --status
            & $python slate/ml_orchestrator.py --benchmarks 2>$null
          }

      - name: VRAM Health
        shell: pwsh
        run: |
          try {
            & nvidia-smi --query-gpu=name,memory.used,memory.total,temperature.gpu,utilization.gpu --format=csv,noheader
          } catch {
            Write-Host "nvidia-smi not available"
          }

      - name: Runner Environment Verify
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python slate/slate_runner_manager.py --status
