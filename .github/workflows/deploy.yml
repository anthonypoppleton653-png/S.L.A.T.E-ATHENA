# Modified: 2026-02-08T15:00:00Z | Author: COPILOT | Change: Create K8s deployment workflow for stable branch with Actions SDK best practices
# SLATE Kubernetes Deployment Workflow
# Triggers on pushes to 'stable' branch — deploys to K8s using self-hosted runners
#
# Best practices applied:
#   - Encrypted secrets via GitHub Secrets (not hardcoded)
#   - Docker build + push to local registry
#   - Kustomize or Helm deploy to K8s cluster
#   - Health checks post-deploy
#   - Rollback on failure
#   - Model caching for fast inference setup

name: Deploy to Kubernetes

on:
  push:
    branches: [stable]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - staging
      deploy_method:
        description: 'Deployment method'
        required: true
        default: 'kustomize'
        type: choice
        options:
          - kustomize
          - helm
      dry_run:
        description: 'Dry run (do not apply changes)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write

env:
  SLATE_VERSION: '2.4.0'
  IMAGE_REGISTRY: 'ghcr.io/synchronizedlivingarchitecture'

jobs:
  # ── Build & Push Docker Images ────────────────────────────────────────────
  build:
    name: Build Docker Images
    runs-on: [self-hosted, slate]
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python PATH
        shell: powershell
        run: '"$env:GITHUB_WORKSPACE\.venv\Scripts" | Out-File -Append $env:GITHUB_PATH'

      - name: Docker metadata
        id: meta
        shell: powershell
        run: |
          $tag = "v$env:SLATE_VERSION-$(Get-Date -Format 'yyyyMMdd')-$($env:GITHUB_SHA.Substring(0,7))"
          echo "version=$tag" >> $env:GITHUB_OUTPUT
          echo "Image tag: $tag"

      - name: Build GPU image
        shell: powershell
        run: |
          docker build -t "$env:IMAGE_REGISTRY/slate:${{ steps.meta.outputs.version }}-gpu" -f Dockerfile .
          docker tag "$env:IMAGE_REGISTRY/slate:${{ steps.meta.outputs.version }}-gpu" "$env:IMAGE_REGISTRY/slate:latest-gpu"

      - name: Build CPU image
        shell: powershell
        run: |
          docker build -t "$env:IMAGE_REGISTRY/slate:${{ steps.meta.outputs.version }}-cpu" -f Dockerfile.cpu .
          docker tag "$env:IMAGE_REGISTRY/slate:${{ steps.meta.outputs.version }}-cpu" "$env:IMAGE_REGISTRY/slate:latest-cpu"

      - name: Push images
        shell: powershell
        if: ${{ !inputs.dry_run }}
        run: |
          docker push "$env:IMAGE_REGISTRY/slate:${{ steps.meta.outputs.version }}-gpu"
          docker push "$env:IMAGE_REGISTRY/slate:latest-gpu"
          docker push "$env:IMAGE_REGISTRY/slate:${{ steps.meta.outputs.version }}-cpu"
          docker push "$env:IMAGE_REGISTRY/slate:latest-cpu"

      - name: Run SLATE health check
        shell: powershell
        run: python slate/slate_status.py --quick

  # ── Security Scan ─────────────────────────────────────────────────────────
  security:
    name: Security Scan
    runs-on: [self-hosted, slate]
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python PATH
        shell: powershell
        run: '"$env:GITHUB_WORKSPACE\.venv\Scripts" | Out-File -Append $env:GITHUB_PATH'

      - name: ActionGuard scan
        shell: powershell
        run: python slate/action_guard.py --scan

      - name: PII scan
        shell: powershell
        run: python slate/pii_scanner.py --scan

      - name: SDK Source Guard
        shell: powershell
        run: python slate/sdk_source_guard.py --verify

  # ── Deploy via Kustomize ──────────────────────────────────────────────────
  deploy-kustomize:
    name: Deploy (Kustomize)
    runs-on: [self-hosted, slate]
    needs: [build, security]
    if: ${{ inputs.deploy_method == 'kustomize' || inputs.deploy_method == '' }}
    environment:
      name: ${{ inputs.environment || 'local' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python PATH
        shell: powershell
        run: '"$env:GITHUB_WORKSPACE\.venv\Scripts" | Out-File -Append $env:GITHUB_PATH'

      - name: Validate manifests
        shell: powershell
        run: |
          kubectl apply -k k8s/ --dry-run=client -o yaml | Out-Null
          echo "Manifests validated successfully"

      - name: Deploy to K8s
        shell: powershell
        if: ${{ !inputs.dry_run }}
        run: |
          $overlay = if ("${{ inputs.environment }}" -eq "local") { "k8s/overlays/local/" } else { "k8s/" }
          kubectl apply -k $overlay
          echo "Deployed using Kustomize overlay: $overlay"

      - name: Wait for rollout
        shell: powershell
        if: ${{ !inputs.dry_run }}
        run: |
          kubectl rollout status deployment/slate-core -n slate --timeout=300s
          kubectl rollout status deployment/ollama -n slate --timeout=300s

      - name: Post-deploy health check
        shell: powershell
        if: ${{ !inputs.dry_run }}
        run: |
          Start-Sleep -Seconds 15
          $pods = kubectl get pods -n slate -o json | ConvertFrom-Json
          $ready = ($pods.items | Where-Object { $_.status.phase -eq 'Running' }).Count
          $total = $pods.items.Count
          echo "Pods: $ready/$total running"
          if ($ready -lt $total) {
            echo "::warning::Not all pods are running"
          }

      - name: Rollback on failure
        shell: powershell
        if: failure()
        run: |
          echo "Deployment failed — rolling back"
          kubectl rollout undo deployment/slate-core -n slate
          kubectl rollout undo deployment/ollama -n slate

  # ── Deploy via Helm ───────────────────────────────────────────────────────
  deploy-helm:
    name: Deploy (Helm)
    runs-on: [self-hosted, slate]
    needs: [build, security]
    if: ${{ inputs.deploy_method == 'helm' }}
    environment:
      name: ${{ inputs.environment || 'local' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Helm lint
        shell: powershell
        run: helm lint ./helm

      - name: Helm deploy
        shell: powershell
        if: ${{ !inputs.dry_run }}
        run: |
          $values = if ("${{ inputs.environment }}" -eq "local") { "--set gpu.enabled=false --set core.replicas=1" } else { "" }
          helm upgrade --install slate ./helm `
            --namespace slate --create-namespace `
            --set core.image.tag="${{ needs.build.outputs.image_tag }}-gpu" `
            $values `
            --wait --timeout 5m

      - name: Helm dry-run
        shell: powershell
        if: ${{ inputs.dry_run }}
        run: |
          helm upgrade --install slate ./helm `
            --namespace slate --create-namespace `
            --dry-run --debug

      - name: Rollback on failure
        shell: powershell
        if: failure()
        run: helm rollback slate -n slate

  # ── Post-Deploy Validation ───────────────────────────────────────────────
  validate:
    name: Post-Deploy Validation
    runs-on: [self-hosted, slate]
    needs: [deploy-kustomize, deploy-helm]
    if: always() && !inputs.dry_run && (needs.deploy-kustomize.result == 'success' || needs.deploy-helm.result == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python PATH
        shell: powershell
        run: '"$env:GITHUB_WORKSPACE\.venv\Scripts" | Out-File -Append $env:GITHUB_PATH'

      - name: Verify pods
        shell: powershell
        run: kubectl get pods -n slate -o wide

      - name: Verify services
        shell: powershell
        run: kubectl get svc -n slate

      - name: SLATE stability check
        shell: powershell
        run: python slate/stability.py --status

      - name: Metrics endpoint check
        shell: powershell
        run: |
          # Port-forward metrics and check
          Start-Job -ScriptBlock { kubectl port-forward svc/slate-metrics-svc 9190:9090 -n slate }
          Start-Sleep -Seconds 5
          try {
            $response = Invoke-RestMethod -Uri "http://127.0.0.1:9190/metrics" -TimeoutSec 10
            echo "Metrics endpoint: OK"
            echo $response | Select-Object -First 20
          } catch {
            echo "::warning::Metrics endpoint not reachable (may need time to start)"
          }
          Get-Job | Stop-Job | Remove-Job
