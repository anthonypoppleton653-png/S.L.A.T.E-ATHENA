# 
# Release Workflow
# Modified: 2026-02-07T00:25:00Z | Author: COPILOT | Change: Add workspace prep, fix shell for Windows runner
# Manual release creation with changelog generation, package build, and artifact upload
# 

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2.4.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      publish_package:
        description: 'Publish Python package to GitHub Packages'
        required: false
        default: true
        type: boolean

concurrency:
  group: release
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write
  packages: write

jobs:
  validate:
    name: Validate Release
    runs-on: [self-hosted, slate, windows]
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Validate version format
        shell: bash
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format. Use semver (e.g., 2.4.0 or 2.4.0-beta.1)"
            exit 1
          fi

      - name: Check version not already released
        shell: bash
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Validate version consistency
        shell: bash
        run: |
          TOML_VER=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          INIT_VER=$(python3 -c "
          import re
          content = open('slate/__init__.py').read()
          match = re.search(r'__version__\s*=\s*["\\']([^"\\']+')", content)
          print(match.group(1) if match else 'NOT_FOUND')
          ")
          INPUT_VER="${{ inputs.version }}"
          echo "pyproject.toml: $TOML_VER"
          echo "slate/__init__.py: $INIT_VER"
          echo "Input version: $INPUT_VER"
          if [ "$TOML_VER" != "$INPUT_VER" ]; then
            echo "::warning::pyproject.toml version ($TOML_VER) differs from release version ($INPUT_VER)"
          fi

      - name: Extract changelog for version
        id: changelog
        shell: bash
        run: |
          if [ -f CHANGELOG.md ]; then
            CONTENT=$(python3 -c "
          import re
          with open('CHANGELOG.md') as f:
              text = f.read()
          pattern = r'## \[${{ inputs.version }}\].*?\n(.*?)(?=\n## \[|$)'
          match = re.search(pattern, text, re.DOTALL)
          if match:
              print(match.group(1).strip())
          else:
              print('Release v${{ inputs.version }}')
          ")
            echo "content<<EOF" >> $GITHUB_OUTPUT
            echo "$CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=Release v${{ inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        shell: bash
        run: |
          pip install -e ".[dev]" 2>/dev/null || pip install -r requirements.txt
          pip install pytest
          pytest tests/ -v --tb=short -x -q || true
        continue-on-error: true

  build-package:
    name: Build Python Package
    needs: validate
    runs-on: [self-hosted, slate, windows]
    outputs:
      version: ${{ steps.build.outputs.version }}
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: pip install build twine setuptools wheel

      - name: Build sdist and wheel
        id: build
        shell: bash
        run: |
          python -m build
          twine check dist/*
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "## 📦 Package Build" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: slate-dist-${{ steps.build.outputs.version }}
          path: dist/
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [validate, build-package]
    runs-on: [self-hosted, slate, windows]
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - uses: actions/download-artifact@v4
        with:
          name: slate-dist-${{ needs.build-package.outputs.version }}
          path: dist/

      - name: Create tag
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: "S.L.A.T.E. v${{ inputs.version }}"
          body: |
            ## S.L.A.T.E. v${{ inputs.version }}

            ${{ needs.validate.outputs.changelog }}

            ---

            ### 📦 Installation

            **From GitHub Packages:**
            ```bash
            pip install slate --index-url https://pypi.pkg.github.com/SynchronizedLivingArchitecture/simple
            ```

            **From source:**
            ```bash
            git clone https://github.com/SynchronizedLivingArchitecture/S.L.A.T.E..git
            cd S.L.A.T.E.
            pip install -e .
            ```

            **Quick install:**
            ```bash
            python install_slate.py
            ```

            ### 📋 Full Changelog
            See [CHANGELOG.md](https://github.com/SynchronizedLivingArchitecture/S.L.A.T.E./blob/main/CHANGELOG.md)
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz

  publish-package:
    name: Publish to GitHub Packages
    needs: [build-package, create-release]
    runs-on: [self-hosted, slate, windows]
    if: inputs.publish_package == true || inputs.publish_package == 'true'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: slate-dist-${{ needs.build-package.outputs.version }}
          path: dist/

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install twine
        shell: bash
        run: pip install twine

      - name: Publish package
        shell: bash
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          twine upload --skip-existing dist/* || echo "::warning::Package upload skipped or failed"

  summary:
    name: Release Summary
    needs: [validate, build-package, create-release, publish-package]
    runs-on: [self-hosted, slate, windows]
    if: always()
    steps:
      - name: Summary
        shell: pwsh
        run: |
          echo "## Release v${{ inputs.version }} Results" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Build Package | ${{ needs.build-package.result }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Package Publish | ${{ needs.publish-package.result }} |" >> $env:GITHUB_STEP_SUMMARY
