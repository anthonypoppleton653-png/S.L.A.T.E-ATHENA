# GitHub Projects automation using gh CLI
# Security: PII scanning prevents personal data from reaching public project boards
# Cost: Uses self-hosted runner only (no GitHub-hosted runner costs)
name: Project Automation

on:
  issues:
    types: [opened, edited, labeled, closed, reopened]
  pull_request:
    types: [opened, edited, labeled, closed, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - list-projects
          - list-items
          - sync-tasks
          - scan-pii
        default: list-projects
      project_number:
        description: 'Project number (default: 11)'
        type: string
        default: '11'

env:
  PROJECT_OWNER: SynchronizedLivingArchitecture

defaults:
  run:
    shell: powershell

jobs:
  pii-scan:
    name: PII Security Scan
    runs-on: [self-hosted, slate]
    if: github.event_name == 'issues' || github.event_name == 'pull_request'
    outputs:
      blocked: ${{ steps.scan.outputs.blocked }}
      has_pii: ${{ steps.scan.outputs.has_pii }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        run: |
          'E:\11132025\.venv\Scripts' | Out-File -Append $env:GITHUB_PATH

      - name: Scan for PII
        id: scan
        run: |
          # Get title and body from event
          if ('${{ github.event_name }}' -eq 'issues') {
            $Title = '${{ github.event.issue.title }}'
            $Body = '${{ github.event.issue.body }}'
          } else {
            $Title = '${{ github.event.pull_request.title }}'
            $Body = '${{ github.event.pull_request.body }}'
          }

          # Escape quotes for command line
          $Title = $Title -replace '"', '\"'
          $Body = $Body -replace '"', '\"'

          # Run PII scanner
          try {
            $Result = python slate/pii_scanner.py --title "$Title" --body "$Body" --json 2>$null | ConvertFrom-Json
            $HasPII = $Result.has_pii
            $Blocked = $Result.blocked
            $Message = $Result.message
          } catch {
            $HasPII = $false
            $Blocked = $false
            $Message = ""
          }

          "has_pii=$HasPII" | Out-File -Append $env:GITHUB_OUTPUT
          "blocked=$Blocked" | Out-File -Append $env:GITHUB_OUTPUT

          if ($Blocked -eq $true) {
            Write-Host "::error::BLOCKED - Critical PII detected. This item will NOT be added to public project boards."
            "## PII Security Block" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "Critical PII was detected in this issue/PR. It has been blocked from public project boards." | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "Please remove sensitive information and try again." | Out-File -Append $env:GITHUB_STEP_SUMMARY
            exit 1
          } elseif ($HasPII -eq $true) {
            Write-Host "::warning::PII detected - $Message"
            "## PII Warning" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "PII was detected but is not critical. Content may be redacted." | Out-File -Append $env:GITHUB_STEP_SUMMARY
          } else {
            Write-Host "No PII detected"
            "## PII Scan Passed" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "No personal identifiable information detected." | Out-File -Append $env:GITHUB_STEP_SUMMARY
          }

  auto-add-to-project:
    name: Auto-add to Project
    runs-on: [self-hosted, slate]
    needs: pii-scan
    if: |
      always() &&
      needs.pii-scan.outputs.blocked != 'true' &&
      (github.event_name == 'issues' || github.event_name == 'pull_request')
    permissions:
      issues: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: Add to SLATE BUG TRACKING (bugs)
        if: |
          (github.event_name == 'issues' && contains(toJSON(github.event.issue.labels.*.name), 'bug')) ||
          (github.event_name == 'pull_request' && contains(toJSON(github.event.pull_request.labels.*.name), 'bug'))
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          $ItemUrl = '${{ github.event.issue.html_url }}${{ github.event.pull_request.html_url }}'
          Write-Host "Adding $ItemUrl to project 7 (BUG TRACKING)"
          gh project item-add 7 --owner $env:PROJECT_OWNER --url $ItemUrl 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Already in project or no access" }

      - name: Add to SLATE ROADMAP (features)
        if: |
          (github.event_name == 'issues' && contains(toJSON(github.event.issue.labels.*.name), 'enhancement')) ||
          (github.event_name == 'pull_request' && contains(toJSON(github.event.pull_request.labels.*.name), 'enhancement'))
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          $ItemUrl = '${{ github.event.issue.html_url }}${{ github.event.pull_request.html_url }}'
          Write-Host "Adding $ItemUrl to project 10 (ROADMAP)"
          gh project item-add 10 --owner $env:PROJECT_OWNER --url $ItemUrl 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Already in project or no access" }

      - name: Add to SLATE ITERATIVE DEV (PRs)
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          $ItemUrl = '${{ github.event.pull_request.html_url }}'
          Write-Host "Adding $ItemUrl to project 8 (ITERATIVE DEVELOPMENT)"
          gh project item-add 8 --owner $env:PROJECT_OWNER --url $ItemUrl 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Already in project or no access" }

  manual-actions:
    name: Manual Project Actions
    runs-on: [self-hosted, slate]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        if: inputs.action == 'sync-tasks' || inputs.action == 'scan-pii'

      - name: Setup Python
        if: inputs.action == 'scan-pii'
        run: |
          'E:\11132025\.venv\Scripts' | Out-File -Append $env:GITHUB_PATH

      - name: List Projects
        if: inputs.action == 'list-projects'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## All Projects" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          gh project list --owner $env:PROJECT_OWNER | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: List Items
        if: inputs.action == 'list-items'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## Project ${{ inputs.project_number }} Items" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          gh project item-list ${{ inputs.project_number }} --owner $env:PROJECT_OWNER --limit 50 | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: Sync Tasks to Project
        if: inputs.action == 'sync-tasks'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## Syncing current_tasks.json to Project ${{ inputs.project_number }}" | Out-File -Append $env:GITHUB_STEP_SUMMARY

          if (Test-Path current_tasks.json) {
            $data = Get-Content current_tasks.json | ConvertFrom-Json
            $tasks = if ($data.tasks) { $data.tasks } else { $data }

            foreach ($task in $tasks) {
              if ($task.status -eq 'pending') {
                $title = if ($task.title) { $task.title } else { $task.name }
                if ($title) {
                  Write-Host "Creating: $title"
                  gh project item-create ${{ inputs.project_number }} --owner $env:PROJECT_OWNER --title "$title" 2>$null
                }
              }
            }
            "Sync complete" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          } else {
            "No current_tasks.json found" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          }

      - name: Run PII Scanner Test
        if: inputs.action == 'scan-pii'
        run: |
          "## PII Scanner Self-Test" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          python slate/pii_scanner.py --test | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
