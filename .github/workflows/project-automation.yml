# Modified: 2026-02-07T04:56:45Z | Author: COPILOT | Change: Normalize paths and clean workflow artifacts
# GitHub Projects automation using gh CLI
# Security: PII scanning prevents personal data from reaching public project boards
# Cost: Uses self-hosted runner only (no GitHub-hosted runner costs)
name: Project Automation

on:
  issues:
    types: [opened, edited, labeled, closed, reopened]
  pull_request:
    types: [opened, edited, labeled, closed, reopened, ready_for_review]
  schedule:
    # Process KANBAN board every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - board-status
          - process-kanban
          - sync-to-kanban
          - sync-from-kanban
          - list-projects
          - list-items
          - sync-tasks
          - scan-pii
        default: board-status
      project_number:
        description: 'Project number (5=KANBAN, 7=bugs, 8=iterative, 10=roadmap)'
        type: string
        default: '5'

concurrency:
  group: project-automation-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

env:
  PROJECT_OWNER: SynchronizedLivingArchitecture

defaults:
  run:
    shell: powershell

jobs:
  pii-scan:
    name: PII Security Scan
    runs-on: [self-hosted, slate]
    if: github.event_name == 'issues' || github.event_name == 'pull_request'
    outputs:
      blocked: ${{ steps.scan.outputs.blocked }}
      has_pii: ${{ steps.scan.outputs.has_pii }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH

      - name: Scan for PII
        id: scan
        run: |
          # Get title and body from event
          if ('${{ github.event_name }}' -eq 'issues') {
            $Title = '${{ github.event.issue.title }}'
            $Body = '${{ github.event.issue.body }}'
          } else {
            $Title = '${{ github.event.pull_request.title }}'
            $Body = '${{ github.event.pull_request.body }}'
          }

          # Escape quotes for command line
          $Title = $Title -replace '"', '\"'
          $Body = $Body -replace '"', '\"'

          # Run PII scanner
          try {
            $Result = python slate/pii_scanner.py --title "$Title" --body "$Body" --json 2>$null | ConvertFrom-Json
            $HasPII = $Result.has_pii
            $Blocked = $Result.blocked
            $Message = $Result.message
          } catch {
            $HasPII = $false
            $Blocked = $false
            $Message = ""
          }

          "has_pii=$HasPII" | Out-File -Append $env:GITHUB_OUTPUT
          "blocked=$Blocked" | Out-File -Append $env:GITHUB_OUTPUT

          if ($Blocked -eq $true) {
            Write-Host "::error::BLOCKED - Critical PII detected. This item will NOT be added to public project boards."
            "## PII Security Block" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "Critical PII was detected in this issue/PR. It has been blocked from public project boards." | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "Please remove sensitive information and try again." | Out-File -Append $env:GITHUB_STEP_SUMMARY
            exit 1
          } elseif ($HasPII -eq $true) {
            Write-Host "::warning::PII detected - $Message"
            "## PII Warning" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "PII was detected but is not critical. Content may be redacted." | Out-File -Append $env:GITHUB_STEP_SUMMARY
          } else {
            Write-Host "No PII detected"
            "## PII Scan Passed" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "No personal identifiable information detected." | Out-File -Append $env:GITHUB_STEP_SUMMARY
          }

  auto-add-to-project:
    name: Auto-add to Project
    runs-on: [self-hosted, slate]
    needs: pii-scan
    if: |
      always() &&
      needs.pii-scan.outputs.blocked != 'true' &&
      (github.event_name == 'issues' || github.event_name == 'pull_request')
    permissions:
      issues: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: Add to SLATE BUG TRACKING (bugs)
        if: |
          (github.event_name == 'issues' && contains(toJSON(github.event.issue.labels.*.name), 'bug')) ||
          (github.event_name == 'pull_request' && contains(toJSON(github.event.pull_request.labels.*.name), 'bug'))
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          $ItemUrl = '${{ github.event.issue.html_url }}${{ github.event.pull_request.html_url }}'
          Write-Host "Adding $ItemUrl to project 7 (BUG TRACKING)"
          gh project item-add 7 --owner $env:PROJECT_OWNER --url $ItemUrl 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Already in project or no access" }

      - name: Add to SLATE ROADMAP (features)
        if: |
          (github.event_name == 'issues' && contains(toJSON(github.event.issue.labels.*.name), 'enhancement')) ||
          (github.event_name == 'pull_request' && contains(toJSON(github.event.pull_request.labels.*.name), 'enhancement'))
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          $ItemUrl = '${{ github.event.issue.html_url }}${{ github.event.pull_request.html_url }}'
          Write-Host "Adding $ItemUrl to project 10 (ROADMAP)"
          gh project item-add 10 --owner $env:PROJECT_OWNER --url $ItemUrl 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Already in project or no access" }

      - name: Add to SLATE ITERATIVE DEV (PRs)
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          $ItemUrl = '${{ github.event.pull_request.html_url }}'
          Write-Host "Adding $ItemUrl to project 8 (ITERATIVE DEVELOPMENT)"
          gh project item-add 8 --owner $env:PROJECT_OWNER --url $ItemUrl 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Already in project or no access" }

  manual-actions:
    name: Manual Project Actions
    runs-on: [self-hosted, slate]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH

      - name: Board Status
        if: inputs.action == 'board-status'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## SLATE Project Boards Status" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          python slate/slate_project_board.py --status 2>&1 | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: Process KANBAN
        if: inputs.action == 'process-kanban'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## Processing KANBAN Board" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          python slate/slate_project_board.py --process 2>&1 | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: Sync To KANBAN
        if: inputs.action == 'sync-to-kanban'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## Pushing Tasks to KANBAN" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          python slate/slate_project_board.py --push 2>&1 | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: Sync From KANBAN
        if: inputs.action == 'sync-from-kanban'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## Syncing KANBAN to Tasks" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          python slate/slate_project_board.py --sync 2>&1 | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: List Projects
        if: inputs.action == 'list-projects'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## All Projects" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          gh project list --owner $env:PROJECT_OWNER | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: List Items
        if: inputs.action == 'list-items'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## Project ${{ inputs.project_number }} Items" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          gh project item-list ${{ inputs.project_number }} --owner $env:PROJECT_OWNER --limit 50 | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

      - name: Sync Tasks to Project
        if: inputs.action == 'sync-tasks'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          "## Syncing current_tasks.json to Project ${{ inputs.project_number }}" | Out-File -Append $env:GITHUB_STEP_SUMMARY

          if (Test-Path current_tasks.json) {
            $data = Get-Content current_tasks.json | ConvertFrom-Json
            $tasks = if ($data.tasks) { $data.tasks } else { $data }

            foreach ($task in $tasks) {
              if ($task.status -eq 'pending') {
                $title = if ($task.title) { $task.title } else { $task.name }
                if ($title) {
                  Write-Host "Creating: $title"
                  gh project item-create ${{ inputs.project_number }} --owner $env:PROJECT_OWNER --title "$title" 2>$null
                }
              }
            }
            "Sync complete" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          } else {
            "No current_tasks.json found" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          }

      - name: Run PII Scanner Test
        if: inputs.action == 'scan-pii'
        run: |
          "## PII Scanner Self-Test" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY
          python slate/pii_scanner.py --test | Out-File -Append $env:GITHUB_STEP_SUMMARY
          '```' | Out-File -Append $env:GITHUB_STEP_SUMMARY

  # Scheduled KANBAN processing - runs every 30 minutes
  scheduled-kanban:
    name: Scheduled KANBAN Processing
    runs-on: [self-hosted, slate]
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH

      - name: Process KANBAN Board
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          Write-Host "=== SLATE Scheduled KANBAN Processing ==="
          Write-Host "Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host ""

          # Sync KANBAN items to local tasks
          Write-Host "--- Syncing from KANBAN ---"
          python slate/slate_project_board.py --sync

          # Process the board
          Write-Host ""
          Write-Host "--- Processing KANBAN items ---"
          python slate/slate_project_board.py --process

          # Push any local pending tasks to KANBAN
          Write-Host ""
          Write-Host "--- Pushing pending tasks to KANBAN ---"
          python slate/slate_project_board.py --push

          "## Scheduled KANBAN Processing Complete" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "Processed at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -Append $env:GITHUB_STEP_SUMMARY
