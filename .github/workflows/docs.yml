# Modified: 2026-02-07T12:00:00Z | Author: Claude | Change: Add spec-wiki-sync job for auto wiki generation
# Documentation Validation

name: Docs Validation

on:
  push:
    branches: [main, develop]
    paths:
      - '**.md'
      - 'docs/**'
      - 'specs/**'
      - '.specify/**'
  pull_request:
    branches: [main]
    paths:
      - '**.md'
      - 'docs/**'
      - 'specs/**'
  workflow_dispatch:

# Modified: 2026-02-07T08:30:00Z | Author: COPILOT | Change: Fix concurrency group for PR-triggered workflows
concurrency:
  group: docs-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: powershell

jobs:
  link-check:
    name: Link Check
    runs-on: [self-hosted, slate]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH
      - name: Check internal links
        run: |
          python -c @"
          import os, re, sys
          broken = []
          checked = 0
          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ('node_modules', '.venv', '__pycache__')]
              for f in files:
                  if not f.endswith('.md'):
                      continue
                  filepath = os.path.join(root, f)
                  with open(filepath, 'r', encoding='utf-8', errors='ignore') as fh:
                      content = fh.read()
                  links = re.findall(r'\[([^\]]+)\]\(([^)]+)\)', content)
                  for text, link in links:
                      if link.startswith(('http', '#', 'mailto:')):
                          continue
                      path = link.split('#')[0]
                      if not path:
                          continue
                      target = os.path.normpath(os.path.join(os.path.dirname(filepath), path))
                      checked += 1
                      if not os.path.exists(target):
                          broken.append(f'{filepath}: [{text}]({link})')
          print(f'Checked {checked} internal links')
          if broken:
              print(f'::warning::Found {len(broken)} broken internal links')
              for b in broken[:20]:
                  print(f'  - {b}')
          else:
              print('All internal links OK')
          "@

  readme-check:
    name: README Check
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH
      - name: Validate README
        run: |
          python -c @"
          import os
          if not os.path.exists('README.md'):
              print('::error::README.md not found')
              exit(1)
          with open('README.md', 'r', encoding='utf-8', errors='ignore') as f:
              content = f.read()
          lines = content.strip().split('\n')
          print(f'README.md: {len(lines)} lines')
          if 'SLATE' not in content and 'slate' not in content:
              print('::warning::README.md does not mention SLATE')
          else:
              print('README.md references SLATE: OK')
          "@

  summary:
    name: Docs Summary
    runs-on: [self-hosted, slate]
    needs: [link-check, readme-check]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Generate summary
        run: |
          "## Docs Validation" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Check | Status |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "|-------|--------|" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Link Check | ${{ needs.link-check.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| README Check | ${{ needs.readme-check.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY

  # Modified: 2026-02-07T12:00:00Z | Author: Claude | Change: Spec-Kit Wiki Integration
  spec-wiki-sync:
    name: Spec Wiki Sync
    runs-on: [self-hosted, slate]
    timeout-minutes: 30
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\.venv\Scripts" | Out-File -Append $env:GITHUB_PATH

      - name: Check Ollama
        id: ollama
        run: |
          $ollamaOk = $false
          try {
            $response = Invoke-RestMethod -Uri "http://127.0.0.1:11434/api/tags" -TimeoutSec 10
            if ($response.models) { $ollamaOk = $true }
          } catch { }
          "available=$ollamaOk" | Out-File -Append $env:GITHUB_OUTPUT
          Write-Host "Ollama available: $ollamaOk"

      - name: Process Specs and Generate Wiki
        id: speckit
        run: |
          $python = "$env:GITHUB_WORKSPACE\.venv\Scripts\python.exe"

          Write-Host ""
          Write-Host "Running Spec-Kit Wiki Integration..."
          Write-Host ""

          if ("${{ steps.ollama.outputs.available }}" -eq "True") {
            & $python slate/slate_spec_kit.py --process-all --wiki --analyze
          } else {
            Write-Host "Ollama not available, generating wiki without AI analysis"
            & $python slate/slate_spec_kit.py --process-all --wiki
          }

      - name: Commit Wiki Updates
        run: |
          git config user.name "SLATE Spec-Kit"
          git config user.email "slate-spec-kit@slate.local"

          $changes = git status --porcelain docs/wiki/ specs/*/analysis/
          if ($changes) {
            git add docs/wiki/ specs/*/analysis/
            $msg = "docs: Auto-sync wiki from specs`n`nGenerated by SLATE Spec-Kit`n`nCo-Authored-By: SLATE AI <slate-ai@slate.local>"
            git commit -m $msg
            git push
            Write-Host "Wiki updates committed"
          } else {
            Write-Host "No wiki changes to commit"
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
