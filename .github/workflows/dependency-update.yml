# Modified: 2026-02-07T22:30:00Z | Author: COPILOT | Change: Create dependency update workflow
#
# SLATE Dependency Update Workflow
# Author: COPILOT | Created: 2026-02-07T22:30:00Z
#
# Runs weekly (or on demand) to:
#   1. Check for outdated pip dependencies
#   2. Regenerate requirements.lock with exact pins
#   3. Verify the updated deps pass CI
#   4. Open a PR if anything changed
#
# This complements Dependabot (which handles individual package PRs)
# by also maintaining the lock file and running SLATE-specific validation.
#

name: Dependency Update

on:
  schedule:
    - cron: '0 8 * * 1'  # Monday 8am UTC
  workflow_dispatch:
    inputs:
      upgrade:
        description: 'Upgrade all deps to latest compatible versions'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      dry_run:
        description: 'Dry run — report only, no PR'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write
  pull-requests: write

# Modified: 2026-02-07T08:30:00Z | Author: COPILOT | Change: Add concurrency block per GitHub docs
concurrency:
  group: dependency-update-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update-deps:
    name: Update Dependencies
    runs-on: [self-hosted, slate]
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python PATH
        run: |
          "$env:GITHUB_WORKSPACE\.venv\Scripts" | Out-File -Append $env:GITHUB_PATH

      - name: Check outdated packages
        id: outdated
        run: |
          Write-Host "═══════════════════════════════════════════════════"
          Write-Host "  Checking for outdated dependencies"
          Write-Host "═══════════════════════════════════════════════════"
          
          $outdated = pip list --outdated --format=json 2>$null | ConvertFrom-Json
          $count = ($outdated | Measure-Object).Count
          
          Write-Host ""
          Write-Host "Found $count outdated package(s):"
          $outdated | ForEach-Object {
            Write-Host "  $($_.name): $($_.version) → $($_.latest_version)"
          }
          
          "outdated_count=$count" | Out-File -Append $env:GITHUB_OUTPUT
          
          # Save report
          $outdated | ConvertTo-Json | Out-File -FilePath outdated_report.json -Encoding utf8

      - name: Upgrade dependencies
        if: inputs.upgrade == 'true' || github.event_name == 'schedule'
        run: |
          Write-Host "Upgrading pip dependencies..."
          pip install -r requirements.txt --upgrade --quiet 2>&1
          
          # Re-install SLATE in editable mode
          pip install -e . --quiet 2>&1
          Write-Host "✓ Dependencies upgraded"

      - name: Generate requirements.lock
        id: lock
        run: |
          Write-Host "Generating requirements.lock..."
          
          # Header
          $header = @"
          # requirements.lock — Auto-generated pinned dependencies
          # Generated: $(Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ')
          # Source: requirements.txt + pyproject.toml
          # DO NOT EDIT — regenerated by dependency-update workflow
          # Install: pip install -r requirements.lock
          #
          "@
          
          $header | Out-File -FilePath requirements.lock -Encoding utf8
          
          # Freeze current state (exclude editable installs)
          pip freeze --exclude-editable 2>$null | Out-File -Append -FilePath requirements.lock -Encoding utf8
          
          Write-Host "✓ requirements.lock generated"
          
          # Check if lock file changed
          $diff = git diff --name-only requirements.lock 2>$null
          if ($diff) {
            "lock_changed=true" | Out-File -Append $env:GITHUB_OUTPUT
            Write-Host "Lock file has changes"
          } else {
            $untracked = git ls-files --others --exclude-standard requirements.lock 2>$null
            if ($untracked) {
              "lock_changed=true" | Out-File -Append $env:GITHUB_OUTPUT
              Write-Host "Lock file is new"
            } else {
              "lock_changed=false" | Out-File -Append $env:GITHUB_OUTPUT
              Write-Host "Lock file unchanged"
            }
          }

      - name: Run SLATE validation
        run: |
          Write-Host "Running SLATE validation..."
          python slate/slate_status.py --quick
          python slate/slate_runtime.py --check-all

      - name: Run tests
        run: |
          Write-Host "Running test suite..."
          python -m pytest tests/ -x --timeout=120 -q 2>&1 || Write-Host "⚠ Some tests failed"

      - name: Create PR
        if: steps.lock.outputs.lock_changed == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $branch = "deps/update-$(Get-Date -Format 'yyyy-MM-dd')"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if branch already exists
          $existing = git branch -r --list "origin/$branch" 2>$null
          if ($existing) {
            Write-Host "Branch $branch already exists, updating..."
            git checkout $branch
            git pull origin $branch
          } else {
            git checkout -b $branch
          }
          
          git add requirements.lock
          git add requirements.txt
          git add pyproject.toml
          
          $status = git status --porcelain
          if (-not $status) {
            Write-Host "No changes to commit"
            exit 0
          }
          
          git commit -m "deps: update requirements.lock $(Get-Date -Format 'yyyy-MM-dd')

          Auto-generated by dependency-update workflow.
          
          Changes:
          $(git diff --cached --stat)"
          
          git push origin $branch
          
          # Create PR if one doesn't exist
          $existingPR = gh pr list --head $branch --json number --jq '.[0].number' 2>$null
          if (-not $existingPR) {
            gh pr create `
              --title "deps: Update dependencies $(Get-Date -Format 'yyyy-MM-dd')" `
              --body "## Dependency Update`n`nAuto-generated weekly dependency update.`n`n### Changes`n- Updated ``requirements.lock`` with current pinned versions`n- Ran SLATE validation and tests`n`n### Outdated Packages`n``````json`n$(Get-Content outdated_report.json -Raw)`n```````n`n---`n*Created by dependency-update workflow*" `
              --label "dependencies" `
              --base main
            
            Write-Host "✓ PR created"
          } else {
            Write-Host "✓ PR #$existingPR updated"
          }

      - name: Summary
        run: |
          $count = '${{ steps.outdated.outputs.outdated_count }}'
          $changed = '${{ steps.lock.outputs.lock_changed }}'
          
          "## Dependency Update Report" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Metric | Value |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "|--------|-------|" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Outdated packages | $count |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Lock file changed | $changed |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Run date | $(Get-Date -Format 'yyyy-MM-dd HH:mm') |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
