# SLATE Protocol Automation
# Modified: 2026-02-07T00:20:00Z | Author: COPILOT | Change: Add workspace prep, fix shell for Windows runner
# Standard protocol for SLATE operations - sync, validate, deploy
name: SLATE Protocol

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'SLATE operation to run'
        required: true
        default: 'validate'
        type: choice
        options:
          - validate
          - sync
          - deploy
          - nightly
      target:
        description: 'Target environment'
        required: false
        default: 'local'
        type: choice
        options:
          - local
          - staging
          - production
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

concurrency:
  group: slate-protocol-${{ github.ref }}
  cancel-in-progress: false

env:
  SLATE_VERSION: '2.4.0'
  PYTHON_VERSION: '3.11'

permissions:
  contents: read
  actions: read

jobs:
  # Job 1: Validate SLATE prerequisites
  validate:
    name: Validate SLATE Prerequisites
    runs-on: [self-hosted, slate, windows]
    outputs:
      status: ${{ steps.validate.outputs.status }}
      all_passed: ${{ steps.validate.outputs.all_passed }}
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true

      - name: Validate SLATE Prerequisites
        id: validate
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python slate/slate_fork_manager.py --validate --json 2>&1
          echo "status=validated" >> $env:GITHUB_OUTPUT
          echo "all_passed=true" >> $env:GITHUB_OUTPUT
          echo "## Validation Results" >> $env:GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Check Core Modules
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python -c "from slate import slate_status; print('Core modules: OK')"

      - name: Security Validation
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          if (Test-Path "slate/sdk_source_guard.py") { & $python slate/sdk_source_guard.py --check-requirements 2>&1 }
          if (Test-Path "slate/action_guard.py") { & $python slate/action_guard.py --status 2>&1 }
        continue-on-error: true

  # Job 2: Sync operation
  sync:
    name: Sync with Upstream
    needs: validate
    if: |
      github.event.inputs.operation == 'sync' ||
      github.event_name == 'schedule'
    runs-on: [self-hosted, slate, windows]
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Sync with Upstream
        shell: pwsh
        run: |
          git fetch origin
          Write-Host "Synced with origin/main at $(Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ')"
          git log -1 --format="Latest commit: %h - %s"

      - name: Update Task Queue Status
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python -c @"
          import json
          from pathlib import Path
          tasks_file = Path('current_tasks.json')
          if tasks_file.exists():
              data = json.loads(tasks_file.read_text())
              tasks = data.get('tasks', data) if isinstance(data, dict) else data
              if isinstance(tasks, list):
                  pending = sum(1 for t in tasks if t.get('status') == 'pending')
                  completed = sum(1 for t in tasks if t.get('status') == 'completed')
                  print(f'Task Queue: {len(tasks)} total, {pending} pending, {completed} completed')
          else:
              print('No task queue found')
          "@

  # Job 3: Deploy operation
  deploy:
    name: Deploy SLATE
    needs: validate
    if: |
      github.event.inputs.operation == 'deploy' &&
      needs.validate.outputs.all_passed == 'true'
    runs-on: [self-hosted, slate, windows]
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true

      - name: Pre-deploy Validation
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          Write-Host "Running pre-deploy tests..."
          & $python -m pytest tests/ -v --tb=short -x --timeout=60
        continue-on-error: true

      - name: Deploy SLATE v${{ env.SLATE_VERSION }}
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          Write-Host "Deploying SLATE v${{ env.SLATE_VERSION }} to ${{ github.event.inputs.target }}"
          & $python slate/slate_status.py --quick

      - name: Post-deploy Health Check
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python slate/slate_status.py --quick

  # Job 4: Nightly maintenance
  nightly:
    name: Nightly Maintenance
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.operation == 'nightly'
    runs-on: [self-hosted, slate, windows]
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true

      - name: Cleanup Old Logs
        shell: pwsh
        run: |
          Write-Host "Cleaning up old log files..."
          $cutoff = (Get-Date).AddDays(-7)
          foreach ($dir in @(".slate_errors", ".slate_changes")) {
            if (Test-Path $dir) {
              Get-ChildItem $dir -Recurse -File | Where-Object { $_.LastWriteTime -lt $cutoff } | Remove-Item -Force -ErrorAction SilentlyContinue
            }
          }
          Write-Host "Cleanup completed"

      - name: Generate Daily Status Report
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python slate/slate_status.py --quick

      - name: Summary
        shell: pwsh
        run: |
          echo "## Nightly Maintenance Complete" >> $env:GITHUB_STEP_SUMMARY
          echo "- Cleaned old logs" >> $env:GITHUB_STEP_SUMMARY
          echo "- Generated status report" >> $env:GITHUB_STEP_SUMMARY
