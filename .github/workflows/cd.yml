# 
# Continuous Deployment Workflow
# Modified: 2026-02-07T00:30:00Z | Author: COPILOT | Change: Add workspace prep, fix shell for Windows runner
# Builds EXE, Docker image, Python package, and publishes releases
# 

name: CD - Build & Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      build_exe:
        description: 'Build EXE artifact'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write
  packages: write

jobs:
  version:
    name: Determine Version
    runs-on: [self-hosted, slate, windows]
    outputs:
      version: ${{ steps.ver.outputs.version }}
      is_tag: ${{ steps.ver.outputs.is_tag }}
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true

      - id: ver
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -like "refs/tags/v*") {
            $version = "${{ github.ref }}" -replace '^refs/tags/v', ''
            echo "version=$version" >> $env:GITHUB_OUTPUT
            echo "is_tag=true" >> $env:GITHUB_OUTPUT
          } else {
            $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
            $ver = & $python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])"
            echo "version=$ver" >> $env:GITHUB_OUTPUT
            echo "is_tag=false" >> $env:GITHUB_OUTPUT
          }

  build-exe:
    name: Build Windows EXE
    needs: version
    runs-on: [self-hosted, slate, windows]
    if: ${{ github.event.inputs.build_exe != 'false' }}
    timeout-minutes: 30
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Run smoke tests
        run: python slate/build_smoke_tests.py
      - name: Build EXE
        run: pyinstaller Aurora.spec --noconfirm
      - name: Verify EXE
        run: |
          if (Test-Path "dist_v2/SLATEPI/SLATEPI.exe") {
            Write-Host "EXE built successfully"
            $size = (Get-Item "dist_v2/SLATEPI/SLATEPI.exe").Length / 1MB
            Write-Host "Size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Host "::error::EXE not found"
            exit 1
          }
        shell: pwsh
      - uses: actions/upload-artifact@v4
        with:
          name: SLATEPI-exe-${{ needs.version.outputs.version }}
          path: dist_v2/SLATEPI/
          retention-days: 30

  release:
    name: Create Release
    needs: [version, build-exe]
    runs-on: [self-hosted, slate, windows]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true
      - uses: actions/download-artifact@v4
        with:
          name: SLATEPI-exe-${{ needs.version.outputs.version }}
          path: release-artifacts/
      - name: Create release archive
        shell: pwsh
        run: |
          Compress-Archive -Path release-artifacts\* -DestinationPath "SLATEPI-${{ needs.version.outputs.version }}-win64.zip" -Force
      - uses: softprops/action-gh-release@v2
        with:
          name: SLATEPI v${{ needs.version.outputs.version }}
          generate_release_notes: true
          files: SLATEPI-${{ needs.version.outputs.version }}-win64.zip

  build-package:
    name: Build Python Package
    needs: version
    runs-on: [self-hosted, slate, windows]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          if (-not (Test-Path $ws)) {
            New-Item -ItemType Directory -Path $ws -Force | Out-Null
            Write-Host "Created workspace: $ws"
          }

      - uses: actions/checkout@v4
        with:
          clean: true
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install build tools
        run: pip install build twine
      - name: Build package
        run: |
          python -m build
          twine check dist/*
      - uses: actions/upload-artifact@v4
        with:
          name: slate-pypackage-${{ needs.version.outputs.version }}
          path: dist/
          retention-days: 90
      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz

  publish-package:
    name: Publish to GitHub Packages
    needs: [version, build-package]
    runs-on: [self-hosted, slate, windows]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: slate-pypackage-${{ needs.version.outputs.version }}
          path: dist/
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Publish
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pip install twine
          twine upload --skip-existing dist/* || echo "Package upload skipped"

  summary:
    name: CD Summary
    needs: [version, build-exe, release, build-package, publish-package]
    runs-on: [self-hosted, slate, windows]
    if: always()
    steps:
      - name: Summary
        shell: pwsh
        run: |
          echo "## CD Results" >> $env:GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Version (${{ needs.version.outputs.version }}) | ${{ needs.version.result }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Build EXE | ${{ needs.build-exe.result }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Build Package | ${{ needs.build-package.result }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Publish Package | ${{ needs.publish-package.result }} |" >> $env:GITHUB_STEP_SUMMARY
