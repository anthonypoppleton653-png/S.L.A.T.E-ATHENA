# Modified: 2026-02-08T15:00:00Z | Author: COPILOT | Change: Integrate with stable release pipeline, add live update triggers
# Modified: 2026-02-07T04:56:45Z | Author: COPILOT | Change: Normalize paths and clean workflow artifacts
# Continuous Deployment Workflow
# Builds EXE and publishes releases
# Coordinates with: stable-release.yml (primary), docker.yml, service-management.yml
# Reference: https://github.com/features/actions

name: CD - Build & Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      build_exe:
        description: 'Build EXE artifact'
        required: false
        default: 'true'
        type: boolean
  # Called by stable-release.yml after validation
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: false
        type: string
      trigger:
        description: 'Trigger source'
        required: false
        type: string
        default: 'manual'

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

defaults:
  run:
    shell: powershell

jobs:
  version:
    name: Determine Version
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    outputs:
      version: ${{ steps.ver.outputs.version }}
      is_tag: ${{ steps.ver.outputs.is_tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH
      - id: ver
        run: |
          if ("${{ github.ref }}".StartsWith("refs/tags/v")) {
            $ver = "${{ github.ref }}" -replace "^refs/tags/v", ""
            "version=$ver" | Out-File -Append $env:GITHUB_OUTPUT
            "is_tag=true" | Out-File -Append $env:GITHUB_OUTPUT
          } else {
            $ver = python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])"
            "version=$ver" | Out-File -Append $env:GITHUB_OUTPUT
            "is_tag=false" | Out-File -Append $env:GITHUB_OUTPUT
          }

  build-exe:
    name: Build Windows EXE
    needs: version
    runs-on: [self-hosted, slate]
    if: ${{ github.event.inputs.build_exe != 'false' }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
        continue-on-error: true
      - name: Run smoke tests
        run: |
          python -c "import slate; print(f'SDK v{slate.__version__}')"
          python -c "import slate.slate_status; print('slate_status OK')"
          python -c "import slate.slate_runtime; print('slate_runtime OK')"
          Write-Host "Build smoke tests passed"
      - name: Build EXE
        run: |
          if (Test-Path "slate.spec") {
            pyinstaller slate.spec --noconfirm
          } else {
            Write-Host "::warning::No slate.spec found, skipping EXE build"
          }
        continue-on-error: true
      - name: Verify EXE
        run: |
          if (Test-Path "dist_v2/SLATEPI/SLATEPI.exe") {
            Write-Host "EXE built successfully"
            $size = (Get-Item "dist_v2/SLATEPI/SLATEPI.exe").Length / 1MB
            Write-Host "Size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Host "::warning::EXE not found (spec may be missing)"
          }
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: hashFiles('dist_v2/SLATEPI/SLATEPI.exe') != ''
        with:
          name: SLATEPI-exe-${{ needs.version.outputs.version }}
          path: dist_v2/SLATEPI/
          retention-days: 30

  release:
    name: Create Release
    needs: [version, build-exe]
    runs-on: [self-hosted, slate]
    if: startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        run: |
          "$env:GITHUB_WORKSPACE\\.venv\\Scripts" | Out-File -Append $env:GITHUB_PATH
      - uses: actions/download-artifact@v7
        with:
          name: SLATEPI-exe-${{ needs.version.outputs.version }}
          path: release-artifacts/
      - name: Create release archive
        run: |
          Compress-Archive -Path "release-artifacts/*" -DestinationPath "SLATEPI-${{ needs.version.outputs.version }}-win64.zip"
      - uses: softprops/action-gh-release@v2
        with:
          name: SLATEPI v${{ needs.version.outputs.version }}
          generate_release_notes: true
          files: SLATEPI-${{ needs.version.outputs.version }}-win64.zip

  summary:
    name: CD Summary
    needs: [version, build-exe, release]
    runs-on: [self-hosted, slate]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Summary
        run: |
          "## CD Results" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Stage | Status |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "|-------|--------|" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Version (${{ needs.version.outputs.version }}) | ${{ needs.version.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Build EXE | ${{ needs.build-exe.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Release | ${{ needs.release.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
