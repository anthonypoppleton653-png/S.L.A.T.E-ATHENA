# 
# Continuous Deployment Workflow
# Author: COPILOT | Created: 2026-01-20T00:00:00Z | Modified: 2026-02-06T14:00:00Z
# Builds EXE, Docker image, and publishes releases
# 

name: CD - Build & Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      build_exe:
        description: 'Build EXE artifact'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write
  packages: write

jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
      is_tag: ${{ steps.ver.outputs.is_tag }}
    steps:
      - uses: actions/checkout@v4
      - id: ver
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            VER=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
            echo "version=$VER" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

  build-exe:
    name: Build Windows EXE
    needs: version
    runs-on: windows-latest
    if: ${{ github.event.inputs.build_exe != 'false' }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Run smoke tests
        run: python aurora_core/build_smoke_tests.py
      - name: Build EXE
        run: pyinstaller Aurora.spec --noconfirm
      - name: Verify EXE
        run: |
          if (Test-Path "dist_v2/SLATEPI/SLATEPI.exe") {
            Write-Host "EXE built successfully"
            $size = (Get-Item "dist_v2/SLATEPI/SLATEPI.exe").Length / 1MB
            Write-Host "Size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Host "::error::EXE not found"
            exit 1
          }
        shell: pwsh
      - uses: actions/upload-artifact@v4
        with:
          name: SLATEPI-exe-${{ needs.version.outputs.version }}
          path: dist_v2/SLATEPI/
          retention-days: 30

  release:
    name: Create Release
    needs: [version, build-exe]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: SLATEPI-exe-${{ needs.version.outputs.version }}
          path: release-artifacts/
      - name: Create release archive
        run: |
          cd release-artifacts
          zip -r ../SLATEPI-${{ needs.version.outputs.version }}-win64.zip .
      - uses: softprops/action-gh-release@v2
        with:
          name: SLATEPI v${{ needs.version.outputs.version }}
          generate_release_notes: true
          files: SLATEPI-${{ needs.version.outputs.version }}-win64.zip

  summary:
    name: CD Summary
    needs: [version, build-exe, release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## CD Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version (${{ needs.version.outputs.version }}) | ${{ needs.version.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build EXE | ${{ needs.build-exe.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
