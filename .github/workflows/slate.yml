# 
# SLATE System Integration Workflow
# Author: COPILOT | Created: 2026-02-02T00:00:00Z | Modified: 2026-02-09T06:50:00Z
# Validates SLATE-specific subsystems: tech tree, nemo, dashboard, agents, tasks
# Includes self-hosted runner jobs for GPU-capable validation
# 

name: SLATE Integration

on:
  push:
    branches: [main, develop, '001-*', '002-*', '003-*', '004-*']
    paths:
      - 'slate/**'
      - 'agents/**'
      - '.slate_tech_tree/**'
      - '.slate_nemo/**'
      - 'current_tasks.json'
      - 'pyproject.toml'
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: slate-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read

jobs:
  slate-status:
    name: SLATE Status Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: Run SLATE Status
        run: python slate/slate_status.py --quick
        continue-on-error: true

  sdk-validation:
    name: SDK Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: Validate SDK version sync
        run: |
          python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              c = tomllib.load(f)
          toml_ver = c['project']['version']
          import slate
          sdk_ver = slate.__version__
          print(f'pyproject.toml: {toml_ver}')
          print(f'slate:          {sdk_ver}')
          assert toml_ver == sdk_ver, f'VERSION MISMATCH: {toml_ver} != {sdk_ver}'
          print('Version sync: OK')
          "

  tech-tree-validation:
    name: Tech Tree Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Validate Tech Tree JSON
        run: |
          python -c "
          import json, sys, os
          path = '.slate_tech_tree/tech_tree.json'
          if not os.path.exists(path):
              print('Tech Tree: Not configured (file not found, skipping)')
              sys.exit(0)
          with open(path, 'r') as f:
              tree = json.load(f)
          nodes = tree.get('nodes', [])
          completed = sum(1 for n in nodes if n.get('status') == 'complete')
          total = len(nodes)
          progress = (completed / total * 100) if total > 0 else 0
          print(f'Tech Tree: {completed}/{total} nodes complete ({progress:.1f}%)')
          "

  dashboard-smoke-test:
    name: Dashboard Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: Test Dashboard Import
        run: |
          python -c "
          try:
              from agents.slate_dashboard_server import app
              print('Dashboard module imports successfully')
          except ImportError as e:
              print(f'Dashboard import failed: {e}')
              exit(1)
          "

  agent-initialization:
    name: Agent Initialization Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      - name: Test Agent Module Imports
        run: |
          python -c "
          import sys
          errors = []
          modules = [
              'slate.slate_status',
              'slate.slate_sdk',
              'slate.slate_runner_manager',
              'slate.slate_runtime',
              'slate.slate_hardware_optimizer',
          ]
          for mod in modules:
              try:
                  __import__(mod)
                  print(f'OK {mod}')
              except Exception as e:
                  print(f'FAIL {mod}: {e}')
                  errors.append(mod)
          if errors:
              print(f'Failed to import {len(errors)} modules')
              sys.exit(1)
          else:
              print('All agent modules import successfully')
          "

  task-queue-check:
    name: Task Queue Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Validate Task Queue
        run: |
          python -c "
          import json, os, sys
          path = 'current_tasks.json'
          if not os.path.exists(path):
              print('Task Queue: Not configured (file not found, skipping)')
              sys.exit(0)
          with open(path, 'r') as f:
              data = json.load(f)
          tasks = data.get('tasks', data) if isinstance(data, dict) else data
          if not isinstance(tasks, list):
              print('Task Queue: Invalid format, skipping')
              sys.exit(0)
          pending = [t for t in tasks if isinstance(t, dict) and t.get('status') == 'pending']
          in_progress = [t for t in tasks if isinstance(t, dict) and t.get('status') == 'in_progress']
          completed = [t for t in tasks if isinstance(t, dict) and t.get('status') == 'completed']
          print(f'Task Queue: {len(pending)} pending, {len(in_progress)} in-progress, {len(completed)} completed')
          print(f'Total: {len(tasks)} tasks')
          "

  summary:
    name: SLATE Summary
    needs: [slate-status, sdk-validation, tech-tree-validation, dashboard-smoke-test, agent-initialization, task-queue-check, gpu-slate-validation]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## SLATE Integration Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SLATE Status | ${{ needs.slate-status.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK Validation | ${{ needs.sdk-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tech Tree | ${{ needs.tech-tree-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | ${{ needs.dashboard-smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | ${{ needs.agent-initialization.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Task Queue | ${{ needs.task-queue-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GPU Validation | ${{ needs.gpu-slate-validation.result }} |" >> $GITHUB_STEP_SUMMARY

  # ─── Self-Hosted Runner: GPU-Accelerated Validation ──────────────────────
  gpu-slate-validation:
    name: "GPU SLATE Validation (Self-Hosted)"
    runs-on: [self-hosted, slate, gpu, windows]
    timeout-minutes: 15
    continue-on-error: true  # Don't fail workflow if runner is offline
    steps:
      - name: Clean workspace
        shell: pwsh
        run: |
          if (Test-Path "${{ github.workspace }}") {
            Write-Host "Workspace exists: ${{ github.workspace }}"
          } else {
            New-Item -ItemType Directory -Path "${{ github.workspace }}" -Force | Out-Null
            Write-Host "Created workspace: ${{ github.workspace }}"
          }

      - uses: actions/checkout@v4
        with:
          clean: true

      - name: GPU Environment
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          Write-Host "=== Self-Hosted GPU Validation ===" -ForegroundColor Cyan

          # GPU detection
          try {
            & nvidia-smi --query-gpu=name,memory.total,compute_cap --format=csv,noheader
          } catch {
            Write-Host "nvidia-smi not available"
          }

      - name: SLATE Status (GPU Runner)
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python slate/slate_status.py --quick

      - name: Runner Manager Status
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python slate/slate_runner_manager.py --status --json

      - name: PyTorch GPU Validation
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          & $python -c @"
          try:
              import torch
              if torch.cuda.is_available():
                  for i in range(torch.cuda.device_count()):
                      print(f'GPU {i}: {torch.cuda.get_device_name(i)}')
                  t = torch.randn(512, 512, device='cuda')
                  r = torch.mm(t, t)
                  print(f'GPU compute test: OK')
                  del t, r; torch.cuda.empty_cache()
              else:
                  print('CUDA not available in PyTorch')
          except ImportError:
              print('PyTorch not installed on runner')
          "@

      - name: Hardware Optimizer (GPU)
        shell: pwsh
        run: |
          $python = if (Test-Path ".venv\Scripts\python.exe") { ".venv\Scripts\python.exe" } else { "python" }
          if (Test-Path "slate/slate_hardware_optimizer.py") {
            & $python slate/slate_hardware_optimizer.py 2>$null
          }
