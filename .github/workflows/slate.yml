# Modified: 2026-02-07T00:00:00Z | Author: COPILOT | Change: Simplified after repo rename (removed trailing dot)
name: SLATE Integration

on:
  push:
    branches: [main, develop, 'feature/*']
  workflow_dispatch:

concurrency:
  group: slate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: powershell

jobs:
  slate-status:
    name: SLATE Status Check
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: SLATE Status
        run: python slate/slate_status.py --quick

  sdk-validation:
    name: SDK Validation
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Import all modules
        run: |
          python -c @"
          import importlib, pathlib, sys
          ok, fail = [], []
          for f in sorted(pathlib.Path('slate').glob('*.py')):
              mod = f.stem
              if mod.startswith('_'): continue
              try:
                  importlib.import_module(f'slate.{mod}')
                  ok.append(mod)
                  print(f'  OK: slate.{mod}')
              except Exception as e:
                  fail.append((mod, str(e)))
                  print(f'  FAIL: slate.{mod}: {e}')
          print(f'Audit: {len(ok)} OK, {len(fail)} failed')
          if fail: sys.exit(1)
          "@

  tech-tree:
    name: Tech Tree Validation
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Validate tech tree
        run: |
          python -c @"
          import json, pathlib
          p = pathlib.Path('.slate_tech_tree/tech_tree.json')
          if p.exists():
              tree = json.loads(p.read_text())
              nodes = tree.get('nodes', [])
              total = len(nodes)
              complete = sum(1 for n in nodes if n.get('status') == 'complete')
              print(f'Tech Tree: {complete}/{total} nodes complete')
          else:
              print('No tech tree found')
          "@

  dashboard:
    name: Dashboard Smoke Test
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Test dashboard import
        run: |
          python -c "from agents.slate_dashboard_server import create_app; print('Dashboard import OK')"
        continue-on-error: true

  agents:
    name: Agent Module Test
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Test agent imports
        run: |
          python -c "import agents; print('agents package OK')"
          python -c "from agents.runner_api import RunnerAPI; print('runner_api OK')"
          python -c "from agents.install_api import InstallAPI; print('install_api OK')"
        continue-on-error: true

  task-queue:
    name: Task Queue Validation
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Validate task queue
        run: |
          python -c @"
          import json, pathlib
          p = pathlib.Path('current_tasks.json')
          if p.exists():
              data = json.loads(p.read_text())
              tasks = data.get('tasks', data) if isinstance(data, dict) else data
              if isinstance(tasks, list):
                  print(f'Task queue: {len(tasks)} tasks')
                  for t in tasks[:5]:
                      status = t.get('status', 'unknown')
                      title = t.get('title', t.get('name', 'unnamed'))
                      print(f'  [{status}] {title}')
              else:
                  print('Task queue format OK')
          else:
              print('No task queue found')
          "@

  summary:
    name: SLATE Summary
    runs-on: [self-hosted, slate]
    needs: [slate-status, sdk-validation, tech-tree, dashboard, agents, task-queue]
    if: always()
    steps:
      - name: Generate summary
        run: |
          "## SLATE Integration Summary" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Check | Status |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "|-------|--------|" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| SLATE Status | ${{ needs.slate-status.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| SDK Validation | ${{ needs.sdk-validation.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Tech Tree | ${{ needs.tech-tree.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Dashboard | ${{ needs.dashboard.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Agents | ${{ needs.agents.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Task Queue | ${{ needs.task-queue.result }} |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
