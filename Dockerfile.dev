# S.L.A.T.E. Docker Image (Dev Variant - GPU with Hot-Reload)
# Modified: 2026-02-08T19:00:00Z | Author: COPILOT | Change: Upgrade to CUDA 12.8, add full runtime with watchfiles
# Base: NVIDIA CUDA 12.8 Runtime on Ubuntu 22.04

FROM nvidia/cuda:12.8.0-runtime-ubuntu22.04

LABEL org.opencontainers.image.source="https://github.com/SynchronizedLivingArchitecture/S.L.A.T.E"
LABEL org.opencontainers.image.description="SLATE - Dev Mode with Hot-Reload (GPU)"
LABEL org.opencontainers.image.licenses="MIT"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Install Python 3.11 and system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-venv \
    python3.11-dev \
    python3-pip \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3.11 /usr/bin/python \
    && ln -sf /usr/bin/python3.11 /usr/bin/python3

# Set working directory
WORKDIR /slate

# Copy requirements first for layer caching
COPY requirements.txt .

# Install Python dependencies + watchfiles for dev hot-reload
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r requirements.txt \
    && pip install --no-cache-dir watchfiles>=1.0.0

# Copy SLATE codebase (will be overridden by bind mounts in dev)
COPY slate/ ./slate/
COPY agents/ ./agents/
COPY slate_core/ ./slate_core/
COPY skills/ ./skills/
COPY pyproject.toml .
COPY current_tasks.json .

# Set Python path
ENV PYTHONPATH="/slate:${PYTHONPATH}"

# Dev mode environment
ENV SLATE_MODE=dev
ENV SLATE_DOCKER=1

# Expose dashboard port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=15s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)" || exit 1

# Default entrypoint: start SLATE orchestrator in dev mode
ENTRYPOINT ["python", "slate/slate_orchestrator.py"]
CMD ["start", "--mode", "dev"]
